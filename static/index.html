<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘é¡µå†…å®¹æŠ“å–å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-radius: 0 0 12px 12px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-brand:hover {
            color: #764ba2;
        }
        
        .nav-menu {
            display: flex;
            gap: 5px;
        }
        
        .nav-link {
            padding: 10px 20px;
            text-decoration: none;
            color: #555;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
        }

        .result.active {
            display: block;
        }

        .result-header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .result-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .result-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: #666;
            font-size: 14px;
        }

        .result-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .content-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .image-card:hover {
            transform: scale(1.05);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-card .status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.9);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .download-links {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .download-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #45a049;
        }

        /* å³ä¾§æ’åºé¢æ¿æ ·å¼ */
        .sort-panel {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 280px;  /* ä»220pxå¢å¤§åˆ°280px */
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            border: 1px solid #e0e0e0;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .panel-header h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #eee;
            color: #666;
        }
        
        .sortable-list {
            max-height: 350px;  /* ä»300pxå¢å¤§åˆ°350px */
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .sortable-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }
        
        .sortable-item:hover {
            background: #f8f9fa;
        }
        
        .sortable-item.dragging {
            opacity: 0.5;
            background: #e3f2fd;
        }
        
        .sortable-item.over {
            border-top: 2px solid #667eea;
            background: #f0f4ff;
        }
        
        .order-number {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
            min-width: 20px;
            margin-right: 8px;
        }
        
        .sortable-item img {
            width: 55px;  /* ä»45pxå¢å¤§åˆ°55px */
            height: 55px; /* ä»45pxå¢å¤§åˆ°55px */
            object-fit: cover;
            margin-right: 15px;  /* å¢åŠ å³è¾¹è· */
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .filename {
            font-size: 13px;  /* ç¨å¾®å¢å¤§å­—ä½“ */
            color: #666;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;  /* å¢åŠ æœ€å¤§å®½åº¦ */
        }
        
        /* æ’åºé¢æ¿ä¸­çš„GIFæ ‡è¯† */
        .sortable-gif-indicator {
            font-size: 16px;
            margin-right: 8px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* GIFå›¾ç‰‡ç‰¹æ®Šæ ·å¼ - å»é™¤è¾¹æ¡†å’Œåœ†è§’ */
        .sortable-item img[src*='.gif'],
        .sortable-item img[src*='data:image/gif'] {
            border-radius: 0 !important;
            border: none !important;
        }
        
        .panel-footer {
            padding: 12px 15px;
            border-top: 1px solid #eee;
            text-align: center;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }
        
        .btn-secondary {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
        .drag-placeholder {
            height: 65px;
            background: #e3f2fd;
            border: 2px dashed #667eea;
            border-radius: 6px;
            margin: 5px 15px;
        }

        .edit-section.active {
            display: block;
        }

        .edit-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .image-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);  /* æ”¹ä¸ºæ¯è¡Œ2ä¸ªå›¾ç‰‡ */
            gap: 15px;  /* å¢åŠ é—´è·è®©å›¾ç‰‡æ›´å¤§ */
            margin: 15px 0;
        }

        .selectable-image {
            position: relative;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .selectable-image.selected {
            border-color: #667eea;
            transform: scale(0.95);
        }

        .selectable-image img {
            width: 100%;
            height: 180px;  /* å¢åŠ å›¾ç‰‡é«˜åº¦ */
            object-fit: cover;
            display: block;
        }
        
        /* è§†é¢‘ç¼©ç•¥å›¾æ ·å¼ */
        .selectable-video {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 180px;
        }
        
        .selectable-video .video-preview {
            font-size: 48px;
            color: white;
        }
        
        .selectable-video .video-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }
        
        .selectable-video.selected {
            box-shadow: 0 0 0 3px #667eea;
            transform: scale(1.02);
        }
        
        /* ä¸»é€‰æ‹©åŒºåŸŸçš„GIFå›¾ç‰‡ç‰¹æ®Šæ ·å¼ */
        .selectable-image img[src*='.gif'],
        .selectable-image img[src*='data:image/gif'] {
            border-radius: 0 !important;
            border: none !important;
        }

        .selectable-image .checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selectable-image.selected .checkbox {
            background: #667eea;
            border-color: #667eea;
        }

        .selectable-image.selected .checkbox::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
        }
        
        /* å›¾ç‰‡åºå·æ ‡è®° */
        .image-order-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #667eea;
            color: white;
            font-size: 12px;
            font-weight: bold;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .selectable-image.selected .image-order-number {
            display: flex; /* é€‰ä¸­æ—¶æ˜¾ç¤º */
        }
        
        /* GIFæ ‡è¯† */
        .gif-badge {
            position: absolute;
            top: 5px;
            right: 35px; /* é¿å¼€checkbox */
            background: #ff6b6b;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            animation: pulse 2s infinite;
        }
        
        /* æœ¬åœ°ä¸Šä¼ æ ‡è¯† */
        .local-upload-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: #4CAF50;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .image-effects {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .effect-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .effect-btn:hover {
            background: #e0e0e0;
        }

        .content-editor {
            margin: 15px 0;
        }

        .content-editor textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .content-editor textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-header .toggle-icon {
            display: inline-block;
            transition: transform 0.25s;
            font-size: 12px;
            color: #999;
        }

        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .collapsible-body {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.25s ease;
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-body.hidden {
            max-height: 0;
            opacity: 0;
        }

        .ai-summary {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ai-summary h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .ai-summary-content {
            color: #333;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .ai-field-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .ai-field-row .ai-summary-content {
            flex: 1;
        }

        .copy-btn {
            flex-shrink: 0;
            background: none;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            color: #888;
            transition: all 0.2s;
            line-height: 1;
            margin-top: 2px;
        }

        .copy-btn:hover {
            background: #f0f0ff;
            border-color: #667eea;
            color: #667eea;
        }

        .copy-btn:active {
            transform: scale(0.92);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .secondary-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .secondary-btn:hover {
            background: #5a6268;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .examples {
            margin-top: 15px;
        }

        .examples-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .example-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .example-link {
            padding: 6px 12px;
            background: #f0f0f0;
            color: #667eea;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            transition: background 0.3s;
        }

        .example-link:hover {
            background: #e0e0e0;
        }

        /* ===== å›¾ç‰‡æŸ¥çœ‹å™¨ & å»æ°´å° æ¨¡æ€æ¡† ===== */
        .image-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .image-modal-overlay.active {
            display: flex;
        }
        .image-modal {
            position: relative;
            background: #1a1a2e;
            border-radius: 0;  /* å…¨å±æ—¶ä¸éœ€è¦åœ†è§’ */
            width: 100vw;       /* å…¨å±å®½åº¦ */
            height: 100vh;      /* å…¨å±é«˜åº¦ */
            max-width: none;    /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ */
            max-height: none;   /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .image-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;  /* å¢åŠ å†…è¾¹è·ä½¿å…¨å±æ—¶æ›´èˆ’é€‚ */
            background: #16213e;
            color: white;
            flex-shrink: 0;
            border-bottom: 1px solid #2a3a5a;  /* æ·»åŠ åº•éƒ¨åˆ†å‰²çº¿ */
        }
        .image-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .modal-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .modal-toolbar button {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .modal-btn-zoom {
            background: #0f3460;
            color: white;
        }
        .modal-btn-zoom:hover { background: #1a5276; }
        .modal-btn-draw {
            background: #e94560;
            color: white;
        }
        .modal-btn-draw:hover { background: #c0392b; }
        .modal-btn-draw.active {
            background: #27ae60;
            box-shadow: 0 0 0 2px #2ecc71;
        }
        .modal-btn-action {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .modal-btn-action:hover { opacity: 0.9; }
        .modal-btn-action:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .modal-btn-close {
            background: transparent;
            color: #ccc;
            font-size: 22px;
            padding: 4px 10px;
            line-height: 1;
        }
        .modal-btn-close:hover { color: #e94560; }
        .image-modal-body {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
        }
        .image-modal-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease;
            user-select: none;
            -webkit-user-drag: none;
        }
        .image-modal-body canvas {
            position: absolute;
            top: 0; left: 0;
            cursor: crosshair;
        }
        .image-modal-footer {
            padding: 10px 20px;
            background: #16213e;
            color: #aaa;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .region-badge {
            display: inline-block;
            background: #e94560;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 6px;
        }
        .zoom-info {
            color: #667eea;
            font-weight: 500;
        }

        /* æ°´å°åŒºåŸŸåˆ—è¡¨é¢æ¿ */
        .region-list-panel {
            display: none;
            position: absolute;
            right: 10px;
            top: 10px;
            bottom: 10px;
            width: 220px;
            background: rgba(22, 33, 62, 0.95);
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            z-index: 10;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(8px);
        }
        .region-list-panel.active {
            display: flex;
        }
        .region-list-header {
            padding: 10px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            background: rgba(15, 52, 96, 0.8);
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .region-list-header .panel-close {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 16px;
            padding: 0 4px;
            line-height: 1;
        }
        .region-list-header .panel-close:hover { color: #e94560; }
        .region-list-body {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }
        .region-list-body::-webkit-scrollbar { width: 4px; }
        .region-list-body::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .region-list-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }
        .region-list-item:hover {
            background: rgba(233, 69, 96, 0.15);
            border-color: rgba(233, 69, 96, 0.4);
        }
        .region-list-item.highlighted {
            background: rgba(233, 69, 96, 0.25);
            border-color: #e94560;
        }
        .region-item-num {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #e94560;
            color: white;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .region-item-info {
            flex: 1;
            min-width: 0;
        }
        .region-item-size {
            font-size: 12px;
            color: #ccc;
        }
        .region-item-pos {
            font-size: 10px;
            color: #888;
            margin-top: 1px;
        }
        .region-item-del {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .region-item-del:hover {
            color: #e94560;
            background: rgba(233, 69, 96, 0.15);
        }
        .region-list-empty {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 20px 10px;
        }
        .region-list-footer {
            padding: 8px 10px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
            flex-shrink: 0;
        }
        .region-list-footer button {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: #e94560;
            color: white;
            font-weight: 500;
            transition: background 0.15s;
        }
        .region-list-footer button:hover { background: #c0392b; }

        /* Toast é€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            min-width: 280px;
            max-width: 420px;
            padding: 14px 20px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            backdrop-filter: blur(10px);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.hiding {
            transform: translateX(120%);
            opacity: 0;
        }
        .toast-success {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }
        .toast-error {
            background: linear-gradient(135deg, #e17055, #d63031);
        }
        .toast-info {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }
        .toast-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        .toast-body {
            opacity: 0.92;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-brand">ğŸ¬ AINews</a>
            <div class="nav-menu">
                <a href="/" class="nav-link active">ğŸ  ä¸»é¡µ</a>
                <a href="/video-maker" class="nav-link">ğŸ“¹ è§†é¢‘åˆ¶ä½œ</a>
                <a href="/github-video-maker" class="nav-link">ğŸ™ GitHubé¡¹ç›®</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ç½‘é¡µå†…å®¹æŠ“å–å·¥å…·</h1>
            <p>è¾“å…¥ä»»æ„ç½‘å€ï¼Œä¸€é”®æŠ“å–å†…å®¹å’Œå›¾ç‰‡</p>
        </div>

        <div class="card">
            <div class="input-group">
                <input 
                    type="url" 
                    id="urlInput" 
                    placeholder="è¯·è¾“å…¥ç½‘é¡µURLï¼Œä¾‹å¦‚ï¼šhttps://www.36kr.com/p/123456" 
                    required
                >
                <button class="btn" id="fetchBtn" onclick="fetchUrl()">
                    å¼€å§‹æŠ“å–
                </button>
            </div>

            <div class="examples">
                <div class="examples-title">ç¤ºä¾‹é“¾æ¥ï¼š</div>
                <div class="example-links">
                    <a href="#" class="example-link" onclick="fillExample('https://www.36kr.com/p/2492318105786505')">36æ°ªæ–‡ç« </a>
                    <a href="#" class="example-link" onclick="fillExample('https://www.cnblogs.com/')">åšå®¢å›­</a>
                    <a href="#" class="example-link" onclick="fillExample('https://www.infoq.cn/article/latest')">InfoQ</a>
                    <a href="#" class="example-link" onclick="fillExample('https://venturebeat.com/orchestration/new-agent-framework-matches-human-engineered-ai-systems-and-adds-zero')">VentureBeat AIæ–‡ç« </a>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æŠ“å–ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="result" id="result">
                <div class="result-header">
                    <h2 id="resultTitle"></h2>
                    <div class="result-meta">
                        <span>ğŸ• æŠ“å–æ—¶é—´: <strong id="crawlTime"></strong></span>
                        <span>ğŸ“ å†…å®¹é•¿åº¦: <strong id="contentLength"></strong> å­—ç¬¦</span>
                        <span>ğŸ–¼ï¸ å›¾ç‰‡æ•°é‡: <strong id="imagesCount"></strong> å¼ </span>
                    </div>
                </div>

                <h3 class="collapsible-header collapsed" onclick="toggleCollapse(this)">ğŸ“„ å†…å®¹é¢„è§ˆ <span class="toggle-icon">â–¼</span></h3>
                <div class="collapsible-body hidden">
                    <div class="content-preview" id="contentPreview"></div>
                    <div class="download-links">
                        <a href="#" class="download-btn" id="downloadContent" target="_blank">
                            ğŸ“¥ ä¸‹è½½å®Œæ•´å†…å®¹
                        </a>
                        <a href="#" class="download-btn" id="downloadMetadata" target="_blank">
                            ğŸ“Š ä¸‹è½½å…ƒæ•°æ®
                        </a>
                    </div>
                </div>

                <h3 class="collapsible-header collapsed" style="margin-top: 30px;" onclick="toggleCollapse(this)">ğŸ¬ è§†é¢‘åˆ—è¡¨ <span class="toggle-icon">â–¼</span></h3>
                <div class="collapsible-body hidden" id="videosSection">
                    <div class="videos-grid" id="videosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;"></div>
                </div>
                
                <h3 class="collapsible-header collapsed" style="margin-top: 30px;" onclick="toggleCollapse(this)">ğŸ–¼ï¸ å›¾ç‰‡åˆ—è¡¨ <span class="toggle-icon">â–¼</span></h3>
                <div class="collapsible-body hidden">
                    <div class="images-grid" id="imagesGrid"></div>
                </div>

                <div class="edit-section" id="editSection">
                    <h3>âœï¸ ç¼–è¾‘å†…å®¹å’Œå›¾ç‰‡</h3>
                    
                    <h4>ğŸ“ é€‰æ‹©å’Œç¼–è¾‘æ–‡ç« å†…å®¹</h4>
        let currentData = null;
        let selectedImages = [];

                    <div class="content-editor">
                        <textarea id="contentEditor" placeholder="æ–‡ç« å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥ç¼–è¾‘..."></textarea>
                    </div>

                    <h4 style="margin-top: 20px;">ğŸ–¼ï¸ é€‰æ‹©å›¾ç‰‡ï¼ˆç‚¹å‡»å›¾ç‰‡é€‰æ‹©/å–æ¶ˆé€‰æ‹©ï¼‰</h4>
                    
                    <!-- ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åŒºåŸŸ -->
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <div>
                                <button class="btn" onclick="document.getElementById('localImageInput').click()" style="margin: 0;">
                                    ğŸ“¤ ä¸Šä¼ æœ¬åœ°å›¾ç‰‡
                                </button>
                                <input type="file" id="localImageInput" accept="image/*" multiple style="display: none;" onchange="handleLocalImageUpload(event)">
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                æ”¯æŒ JPGã€PNGã€GIF ç­‰æ ¼å¼ï¼Œå¯å¤šé€‰
                            </div>
                        </div>
                        <div id="uploadStatus" style="margin-top: 10px; font-size: 13px; color: #666; min-height: 20px;"></div>
                    </div>
                    
                    <div class="image-selector" id="imageSelector"></div>

                    <div class="action-buttons">
                        <button class="btn" onclick="generateSummary()">
                            ğŸ¤– ç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦
                        </button>
                        <button class="btn" id="oneClickBtn" onclick="oneClickGenerate()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            ğŸš€ ä¸€é”®ç”Ÿæˆè§†é¢‘
                        </button>
                        <button class="secondary-btn" onclick="resetSelection()">
                            ğŸ”„ é‡ç½®é€‰æ‹©
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404;">
                        ğŸ’¡ æç¤ºï¼šé€‰æ‹©å›¾ç‰‡åç‚¹å‡»"ç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦"ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆè§†é¢‘"ï¼Œå°†ç›´æ¥ä½¿ç”¨å½“å‰ç¼–è¾‘çš„å†…å®¹ç”Ÿæˆè§†é¢‘
                    </div>

                    <div class="ai-summary" id="aiSummary" style="display: none;">
                        <h4>ğŸ¤– AIç”Ÿæˆå†…å®¹</h4>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">ä¸»æ ‡é¢˜ï¼š</strong>
                            <div class="ai-field-row">
                                <input type="text" id="editableMainTitle" class="ai-edit-input" placeholder="ä¸»æ ‡é¢˜å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="font-size: 1.2em; font-weight: bold; margin: 10px 0; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;" />
                                <button class="copy-btn" onclick="copyAiContent('editableMainTitle')" title="å¤åˆ¶ä¸»æ ‡é¢˜">ğŸ“‹</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #667eea;">å‰¯æ ‡é¢˜ï¼š</strong>
                            <div class="ai-field-row">
                                <input type="text" id="editableSubTitle" class="ai-edit-input" placeholder="å‰¯æ ‡é¢˜å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="font-size: 1em; font-weight: normal; margin: 10px 0; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%; color: #666;" />
                                <button class="copy-btn" onclick="copyAiContent('editableSubTitle')" title="å¤åˆ¶å‰¯æ ‡é¢˜">ğŸ“‹</button>
                            </div>
                        </div>
                        <div>
                            <strong style="color: #667eea;">æ‘˜è¦ï¼š</strong>
                            <div class="ai-field-row">
                                <textarea id="editableAiSummary" class="ai-edit-input" rows="4" placeholder="AIç”Ÿæˆçš„æ‘˜è¦å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                                <button class="copy-btn" onclick="copyAiContent('editableAiSummary')" title="å¤åˆ¶æ‘˜è¦">ğŸ“‹</button>
                            </div>
                        </div>
                        <div>
                            <strong style="color: #667eea;">æ ‡ç­¾ï¼š</strong>
                            <div class="ai-field-row">
                                <input type="text" id="editableAiTags" class="ai-edit-input" placeholder="#AI #äººå·¥æ™ºèƒ½ #ç§‘æŠ€..." style="margin-top: 8px; color: #764ba2; font-size: 14px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; width: 100%;" />
                                <button class="copy-btn" onclick="copyAiContent('editableAiTags')" title="å¤åˆ¶æ ‡ç­¾">ğŸ“‹</button>
                            </div>
                        </div>
                        <div style="margin-top: 10px; color: #666; font-size: 12px;" id="aiMeta"></div>
                        
                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn" onclick="generateVideoDirectly()">
                                ğŸ¬ ç”Ÿæˆè§†é¢‘
                            </button>
                            <button class="secondary-btn" onclick="saveEditedContent()" title="ä¿å­˜ä¿®æ”¹åçš„å†…å®¹ç”¨äºè§†é¢‘ç”Ÿæˆ">
                                ğŸ’¾ ä¿å­˜ä¿®æ”¹
                            </button>
                            <button class="secondary-btn" onclick="analyzeSelectedGIFs()" title="åˆ†æé€‰ä¸­çš„GIFå›¾ç‰‡å±æ€§">
                                ğŸï¸ åˆ†æGIF
                            </button>
                        </div>
                    </div>

                    <div class="ai-summary" id="generatedImage" style="display: none; margin-top: 20px;">
                        <h4>ğŸ¨ ç”Ÿæˆçš„è§†é¢‘</h4>
                        <div id="framesInfo" style="margin: 10px 0; color: #666; font-size: 14px;"></div>
                        <div id="framesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                        </div>                        <button id="createVideoBtn" onclick="createVideo()" 
                            style="margin-top: 20px; padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;">
                            ğŸ¬ åˆæˆè§†é¢‘ (2.5ç§’/å¸§)
                        </button>

                        <div id="videoResult" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h5 style="margin: 0 0 10px 0; color: #333;">ğŸ¥ è§†é¢‘ç”ŸæˆæˆåŠŸ</h5>
                            <div id="videoInfo" style="margin: 10px 0; color: #666; font-size: 14px;"></div>
                            <video id="generatedVideo" controls style="width: 100%; max-width: 600px; border-radius: 8px; margin-top: 10px;"></video>
                            <div style="margin-top: 10px;">
                                <a id="downloadVideoBtn" download style="display: inline-block; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">
                                    ğŸ’¾ ä¸‹è½½è§†é¢‘
                                </a>
                            </div>
                        </div>                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æ’åºé¢æ¿ -->
        <div id="sortPanel" class="sort-panel">
            <div class="panel-header">
                <h4>ğŸ–¼ï¸ å·²é€‰å›¾ç‰‡æ’åº</h4>
                <button id="closeSortPanel" class="close-btn">Ã—</button>
            </div>
            <div id="sortableList" class="sortable-list">
                <!-- åŠ¨æ€ç”Ÿæˆçš„æ’åºé¡¹ -->
            </div>
            <div class="panel-footer">
                <button id="resetOrder" class="btn-secondary">ğŸ”„ é‡ç½®é¡ºåº</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ & å»æ°´å°æ¨¡æ€æ¡† -->
    <div class="image-modal-overlay" id="imageModalOverlay" onclick="if(event.target===this)closeImageModal()">
        <div class="image-modal">
            <div class="image-modal-header">
                <h3 id="modalTitle">ğŸ” å›¾ç‰‡æŸ¥çœ‹å™¨</h3>
                <div class="modal-toolbar">
                    <button class="modal-btn-zoom" onclick="zoomImage(-0.2)" title="ç¼©å°">â– ç¼©å°</button>
                    <button class="modal-btn-zoom" onclick="zoomImage(0.2)" title="æ”¾å¤§">â• æ”¾å¤§</button>
                    <button class="modal-btn-zoom" onclick="resetZoom()" title="é€‚åº”">ğŸ”„ é€‚åº”</button>
                    <button class="modal-btn-zoom" onclick="toggleFullscreen()" title="åˆ‡æ¢å…¨å±" id="fullscreenBtn">ğŸ”² å…¨å±</button>
                    <span style="color:#555;">|</span>
                    <button class="modal-btn-draw" id="drawModeBtn" onclick="toggleDrawMode()" title="æ¡†é€‰æ°´å°åŒºåŸŸ">âœï¸ æ¡†é€‰æ°´å°</button>
                    <button class="modal-btn-zoom" id="autoDetectBtn" onclick="autoDetectWatermark()" title="AIè‡ªåŠ¨æ£€æµ‹æ°´å°åŒºåŸŸ">ğŸ” è‡ªåŠ¨æ£€æµ‹</button>
                    <button class="modal-btn-action" id="autoRemoveBtn" onclick="autoDetectAndRemove()" title="è‡ªåŠ¨æ£€æµ‹æ°´å°å¹¶ä¸€é”®å»é™¤" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸš€ ä¸€é”®å»æ°´å°</button>
                    <button class="modal-btn-zoom" id="undoRegionBtn" onclick="undoLastRegion()" title="æ’¤é”€ä¸Šä¸€ä¸ªæ¡†é€‰" style="display:none;">â†©ï¸ æ’¤é”€</button>
                    <button class="modal-btn-zoom" id="clearRegionsBtn" onclick="clearRegions()" title="æ¸…é™¤æ‰€æœ‰æ¡†é€‰" style="display:none;">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button class="modal-btn-action" id="removeWatermarkBtn" onclick="removeWatermark()" disabled title="å»é™¤æ°´å°">ğŸ§¹ å»é™¤æ°´å°</button>
                    <span style="color:#555;">|</span>
                    <button class="modal-btn-action" id="useCleanedBtn" onclick="useCleanedImage()" style="display:none;" title="ä½¿ç”¨å»æ°´å°åçš„å›¾ç‰‡">âœ… ä½¿ç”¨æ­¤å›¾</button>
                    <button class="modal-btn-close" onclick="closeImageModal()">âœ•</button>
                </div>
            </div>
            <div class="image-modal-body" id="modalBody">
                <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡" draggable="false">
                <canvas id="modalCanvas"></canvas>
                <!-- æ°´å°åŒºåŸŸåˆ—è¡¨é¢æ¿ -->
                <div class="region-list-panel" id="regionListPanel">
                    <div class="region-list-header">
                        <span>ğŸ“‹ æ£€æµ‹åŒºåŸŸ</span>
                        <button class="panel-close" onclick="toggleRegionPanel(false)" title="å…³é—­é¢æ¿">âœ•</button>
                    </div>
                    <div class="region-list-body" id="regionListBody">
                        <div class="region-list-empty">æš‚æ— æ£€æµ‹åŒºåŸŸ</div>
                    </div>
                    <div class="region-list-footer" id="regionListFooter" style="display:none;">
                        <button onclick="clearRegions()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨åŒºåŸŸ</button>
                    </div>
                </div>
            </div>
            <div class="image-modal-footer">
                <div>
                    <span id="modalImageInfo">-</span>
                    <span id="regionsCount"></span>
                </div>
                <div class="zoom-info" id="zoomLevel">100%</div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <script>
        function showToast(message, type = 'success', duration = 3500) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            toast.innerHTML = `<div class="toast-title">${icon} ${type === 'success' ? 'æˆåŠŸ' : type === 'error' ? 'å¤±è´¥' : 'æç¤º'}</div><div class="toast-body">${message}</div>`;
            
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // å…¨å±€å˜é‡å­˜å‚¨ç¼–è¾‘åçš„å†…å®¹
        let editedMainTitle = '';
        let editedSubTitle = '';
        let editedSummary = '';
        let editedTags = '';
        
        // æ‹–æ‹½æ’åºç›¸å…³å˜é‡
        let dragSrcEl = null;
        
        // æ’åºé¢æ¿åŠŸèƒ½
        function initSortPanel() {
            const panel = document.getElementById('sortPanel');
            if (selectedImages.length > 0) {
                panel.style.display = 'block';
                updateSortPanel();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function updateSortPanel() {
            const container = document.getElementById('sortableList');
            container.innerHTML = '';
            
            selectedImages.forEach((path, index) => {
                const item = createSortableItem(path, index + 1);
                container.appendChild(item);
            });
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
        }
        
        function createSortableItem(path, order) {
            const div = document.createElement('div');
            div.className = 'sortable-item';
            div.draggable = true;
            div.dataset.path = path;
            
            // æå–æ–‡ä»¶å
            const fileName = path.split('/').pop() || 'åª’ä½“æ–‡ä»¶';
            const displayName = fileName.length > 15 ? fileName.substring(0, 12) + '...' : fileName;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const isGif = path.toLowerCase().endsWith('.gif');
            const isVideo = path.toLowerCase().endsWith('.mp4') || path.toLowerCase().endsWith('.webm') || path.toLowerCase().endsWith('.mov');
            
            let indicator = '';
            let fileType = 'image';
            
            if (isGif) {
                indicator = '<span class="sortable-gif-indicator">ğŸï¸</span>';
                fileType = 'gif';
            } else if (isVideo) {
                indicator = '<span class="sortable-gif-indicator">ğŸ¥</span>';
                fileType = 'video';
            }
            
            div.innerHTML = `
                <span class="order-number">${order}.</span>
                <img src="${isVideo ? 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2255%22 height=%2255%22 viewBox=%220 0 24 24%22 fill=%22%23667eea%22><path d=%22M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z%22/></svg>' : path}" 
                     alt="é€‰ä¸­åª’ä½“" 
                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22currentColor%22 stroke-width=%222%22><rect x=%223%22 y=%223%22 width=%2218%22 height=%2218%22 rx=%222%22/><circle cx=%228.5%22 cy=%228.5%22 r=%221.5%22/><path d=%22M21 15l-5-5L5 21%22/></svg>'">
                ${indicator}
                <span class="filename" title="${fileName} (${fileType})">${displayName}</span>
            `;
            
            return div;
        }
        
        function initDragAndDrop() {
            const items = document.querySelectorAll('.sortable-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
            this.classList.add('dragging');
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            // æ·»åŠ è§†è§‰æŒ‡ç¤ºå™¨
            if (this !== dragSrcEl) {
                this.classList.add('over');
            }
            
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (dragSrcEl !== this) {
                // äº¤æ¢å…ƒç´ ä½ç½®
                const parent = dragSrcEl.parentNode;
                const dragIndex = Array.from(parent.children).indexOf(dragSrcEl);
                const dropIndex = Array.from(parent.children).indexOf(this);
                
                if (dragIndex < dropIndex) {
                    parent.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    parent.insertBefore(dragSrcEl, this);
                }
                
                // æ›´æ–°selectedImagesæ•°ç»„
                updateSelectedImagesFromSort();
                // æ›´æ–°åºå·æ˜¾ç¤º
                updateOrderNumbers();
                // æ›´æ–°ä¸»å›¾ç‰‡åŒºåŸŸåºå·
                updateMainImageNumbers();
            }
            
            return false;
        }
        
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.sortable-item').forEach(item => {
                item.classList.remove('over');
            });
            dragSrcEl = null;
        }
        
        function updateSelectedImagesFromSort() {
            const items = document.querySelectorAll('.sortable-item');
            const newOrder = Array.from(items).map(item => item.dataset.path);
            selectedImages = newOrder;
            console.log('æ’åºå·²æ›´æ–°:', selectedImages);
        }
        
        function updateOrderNumbers() {
            const items = document.querySelectorAll('.sortable-item');
            items.forEach((item, index) => {
                const numberSpan = item.querySelector('.order-number');
                if (numberSpan) {
                    numberSpan.textContent = `${index + 1}.`;
                }
            });
            
            // åŒæ—¶æ›´æ–°ä¸»å›¾ç‰‡åŒºåŸŸçš„åºå·
            updateMainImageNumbers();
        }
        
        function updateMainImageNumbers() {
            // è·å–æ‰€æœ‰é€‰ä¸­çš„å›¾ç‰‡å…ƒç´ 
            const selectedImagesElements = document.querySelectorAll('.selectable-image.selected');
            
            // æ ¹æ®selectedImagesæ•°ç»„çš„é¡ºåºæ›´æ–°åºå·
            selectedImagesElements.forEach((imgElement, index) => {
                const orderNumber = imgElement.querySelector('.image-order-number');
                if (orderNumber) {
                    // æ‰¾åˆ°è¯¥å›¾ç‰‡åœ¨selectedImagesæ•°ç»„ä¸­çš„ä½ç½®
                    const imagePath = imgElement.dataset.path;
                    const arrayIndex = selectedImages.indexOf(imagePath);
                    if (arrayIndex !== -1) {
                        orderNumber.textContent = arrayIndex + 1;
                    }
                }
            });
        }
        
        function hideSortPanel() {
            const panel = document.getElementById('sortPanel');
            panel.style.display = 'none';
        }
        
        function resetImageOrder() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ é‡ç½®é€»è¾‘ï¼Œæ¯”å¦‚æŒ‰åŸå§‹é¡ºåºé‡æ–°æ’åˆ—
            showToast('é¡ºåºé‡ç½®åŠŸèƒ½å¾…å®ç°', 'info');
        }
        
        function saveEditedContent() {
            // ä¿å­˜ç”¨æˆ·ç¼–è¾‘çš„å†…å®¹
            editedMainTitle = document.getElementById('editableMainTitle').value.trim();
            editedSubTitle = document.getElementById('editableSubTitle').value.trim();
            editedSummary = document.getElementById('editableAiSummary').value.trim();
            editedTags = document.getElementById('editableAiTags').value.trim();
            
            if (!editedMainTitle || !editedSummary) {
                showToast('è¯·å¡«å†™ä¸»æ ‡é¢˜å’Œæ‘˜è¦åå†ä¿å­˜', 'error');
                return;
            }
            
            showToast('âœ… å†…å®¹å·²ä¿å­˜ï¼Œå°†åœ¨è§†é¢‘ç”Ÿæˆæ—¶ä½¿ç”¨', 'success');
            console.log('ä¿å­˜çš„ç¼–è¾‘å†…å®¹:', { editedMainTitle, editedSubTitle, editedSummary, editedTags });
        }
        
        // GIFå¤„ç†ç›¸å…³å‡½æ•°
        async function analyzeSelectedGIFs() {
            const gifImages = selectedImages.filter(path => path.toLowerCase().endsWith('.gif'));
            
            if (gifImages.length === 0) {
                showToast('æ²¡æœ‰é€‰ä¸­çš„GIFå›¾ç‰‡', 'info');
                return;
            }
            
            try {
                const analyses = [];
                for (const gifPath of gifImages) {
                    const response = await fetch(`/api/gif/analyze-gif?gif_path=${encodeURIComponent(gifPath)}`);
                    const result = await response.json();
                    if (result.success) {
                        analyses.push({
                            path: gifPath,
                            ...result
                        });
                    }
                }
                
                // æ˜¾ç¤ºåˆ†æç»“æœ
                showGIFAnalysis(analyses);
                
            } catch (error) {
                console.error('GIFåˆ†æå¤±è´¥:', error);
                showToast('GIFåˆ†æå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showGIFAnalysis(analyses) {
            let content = '<h3>ğŸï¸ GIFåˆ†æç»“æœ</h3>';
            
            analyses.forEach(analysis => {
                const props = analysis.properties;
                const compat = analysis.analysis;
                
                content += `
                    <div style="margin: 15px 0; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                        <strong>${analysis.path.split('/').pop()}</strong><br>
                        å¸§æ•°: ${props.frame_count || 'æœªçŸ¥'}<br>
                        æ—¶é•¿: ${(props.duration ? props.duration/1000 : 0).toFixed(2)}ç§’<br>
                        å°ºå¯¸: ${props.size ? `${props.size[0]}Ã—${props.size[1]}` : 'æœªçŸ¥'}<br>
                        å…¼å®¹æ€§: ${compat.is_valid ? 'âœ… è‰¯å¥½' : 'âš ï¸ å­˜åœ¨é—®é¢˜'}
                        ${compat.issues ? `<br>é—®é¢˜: ${compat.issues.join(', ')}` : ''}
                    </div>
                `;
            });
            
            showToast(content, 'info', 5000);
        }
        
        async function processSelectedGIFs(durationPerFrame = 2.5) {
            const gifImages = selectedImages.filter(path => path.toLowerCase().endsWith('.gif'));
            
            if (gifImages.length === 0) {
                showToast('æ²¡æœ‰é€‰ä¸­çš„GIFå›¾ç‰‡éœ€è¦å¤„ç†', 'info');
                return [];
            }
            
            try {
                // æ‰¹é‡å¤„ç†GIF
                const formData = new FormData();
                gifImages.forEach(path => formData.append('gif_paths', path));
                formData.append('target_duration', durationPerFrame.toString());
                
                const response = await fetch('/api/gif/batch-process-gifs', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const successfulVideos = result.results
                        .filter(r => r.status === 'success')
                        .map(r => r.video_path);
                    
                    showToast(`âœ… æˆåŠŸå¤„ç† ${successfulVideos.length}/${gifImages.length} ä¸ªGIF`, 'success');
                    return successfulVideos;
                } else {
                    throw new Error(result.detail || 'å¤„ç†å¤±è´¥');
                }
                
            } catch (error) {
                console.error('GIFå¤„ç†å¤±è´¥:', error);
                showToast('GIFå¤„ç†å¤±è´¥: ' + error.message, 'error');
                return [];
            }
        }
        
        function copyAiContent(elementId) {
            const el = document.getElementById(elementId);
            if (!el) {
                showToast('æœªæ‰¾åˆ°è¦å¤åˆ¶çš„å…ƒç´ ', 'error');
                return;
            }
            
            // æ ¹æ®å…ƒç´ ç±»å‹è·å–å†…å®¹
            let text = '';
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                text = el.value.trim();
            } else {
                text = el.textContent.trim();
            }
            
            if (!text) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'info');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2000);
            }).catch(() => {
                // fallback for older browsers
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand('copy');
                sel.removeAllRanges();
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success', 2000);
            });
        }

        function toggleCollapse(header) {
            const body = header.nextElementSibling;
            header.classList.toggle('collapsed');
            body.classList.toggle('hidden');
        }

        function fillExample(url) {
            event.preventDefault();
            document.getElementById('urlInput').value = url;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰«æè§†é¢‘æ–‡ä»¶
        window.addEventListener('DOMContentLoaded', async function() {
            await scanVideos();
        });

        async function scanVideos() {
            try {
                const response = await fetch('/api/list-videos');
                const data = await response.json();
                
                if (data.success && data.videos && data.videos.length > 0) {
                    displayVideos(data.videos);
                }
            } catch (error) {
                console.error('æ‰«æè§†é¢‘æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        function displayVideos(videos) {
            const videosSection = document.getElementById('videosSection');
            const videosGrid = document.getElementById('videosGrid');
            
            if (!videosSection || !videosGrid) return;
            
            // æ˜¾ç¤ºè§†é¢‘åŒºåŸŸ
            videosSection.style.display = 'block';
            videosGrid.innerHTML = '';
            
            videos.forEach(async (video, index) => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.style.cssText = `
                    position: relative;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: transform 0.2s;
                    background: white;
                `;
                
                // æ„å»ºåˆå§‹HTML
                let videoHtml = `
                    <div style="position: relative; cursor: pointer;" onclick="openVideoModal('${video.local_path}')">
                `;
                
                // æ ¹æ®æ˜¯å¦æœ‰ç¼©ç•¥å›¾æ˜¾ç¤ºä¸åŒå†…å®¹
                if (video.has_thumbnail && video.thumbnail_path) {
                    videoHtml += `
                        <img src="${video.thumbnail_path}" 
                             alt="è§†é¢‘å°é¢" 
                             style="width: 100%; height: 150px; object-fit: cover; display: block;"
                             onerror="this.parentElement.innerHTML='<div style=\'width:100%;height:150px;background:linear-gradient(45deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;\'><span style=\'color:white;font-size:48px;\'>ğŸ¬</span></div>'">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 50%; font-size: 16px;">â–¶ï¸</div>
                    `;
                } else {
                    // é»˜è®¤æ¸å˜èƒŒæ™¯
                    videoHtml += `
                        <div style="width: 100%; height: 150px; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 48px;">ğŸ¬</span>
                        </div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 50%; font-size: 16px;">â–¶ï¸</div>
                    `;
                }
                
                videoHtml += `</div>`;
                
                // ä¿¡æ¯éƒ¨åˆ†
                videoHtml += `
                    <div style="padding: 10px;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 4px; font-weight: 500;">${video.filename}</div>
                        <div style="font-size: 12px; color: #888; display: flex; justify-content: space-between;">
                            <span>${video.size_mb ? video.size_mb.toFixed(1) + 'MB' : 'æœªçŸ¥å¤§å°'}</span>
                            <span>${new Date(video.created_time).toLocaleDateString('zh-CN')}</span>
                        </div>
                    </div>
                    <div style="padding: 6px 10px; font-size: 12px; text-align: center; background: #d4edda; color: #155724; border-top: 1px solid #c3e6cb; display: flex; justify-content: space-between; align-items: center;">
                        <span>âœ“ å·²ç”Ÿæˆ</span>
                        <button onclick="event.stopPropagation(); openVideoModal('${video.local_path}')" 
                                style="background: #667eea; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;">
                            ğŸ‘ï¸ æŸ¥çœ‹
                        </button>
                    </div>
                `;
                
                videoCard.innerHTML = videoHtml;
                videosGrid.appendChild(videoCard);
                
                // å¦‚æœæ²¡æœ‰ç¼©ç•¥å›¾ï¼Œå°è¯•ç”Ÿæˆä¸€ä¸ª
                if (!video.has_thumbnail) {
                    try {
                        const response = await fetch(`/api/extract-thumbnail/${encodeURIComponent(video.filename)}`);
                        const result = await response.json();
                        if (result.success && result.thumbnail_path) {
                            // æ›´æ–°å¡ç‰‡æ˜¾ç¤ºçœŸå®ç¼©ç•¥å›¾
                            const imgContainer = videoCard.querySelector('[onclick^="openVideoModal"]');
                            if (imgContainer) {
                                imgContainer.innerHTML = `
                                    <img src="${result.thumbnail_path}" 
                                         alt="è§†é¢‘å°é¢" 
                                         style="width: 100%; height: 150px; object-fit: cover; display: block;"
                                         onerror="this.outerHTML='<div style=\\'width:100%;height:150px;background:linear-gradient(45deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;\\'><span style=\\'color:white;font-size:48px;\\'>ğŸ¬</span></div>'">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 50%; font-size: 16px;">â–¶ï¸</div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.log('ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥:', error);
                    }
                }
            });
            
            console.log(`âœ… å·²æ˜¾ç¤º ${videos.length} ä¸ªè§†é¢‘æ–‡ä»¶`);
        }

        // è§†é¢‘æ’­æ”¾æ¨¡æ€æ¡†
        function openVideoModal(videoPath) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    <video src="${videoPath}" controls autoplay style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);"></video>
                    <div style="text-align: center; margin-top: 15px; color: white; font-size: 14px;">
                        <a href="${videoPath}" download style="color: #667eea; text-decoration: none;">ğŸ“¥ ä¸‹è½½è§†é¢‘</a>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function fetchUrl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„URL');
                return;
            }

            // éªŒè¯URLæ ¼å¼
            try {
                new URL(url);
            } catch (e) {
                showError('URLæ ¼å¼ä¸æ­£ç¡®');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºVentureBeat URLï¼Œä½¿ç”¨ä¸“é—¨çš„APIç«¯ç‚¹
            let apiUrl = '/api/fetch-url';
            if (url.includes('venturebeat.com')) {
                apiUrl = '/api/fetch-venturebeat';
                console.log('æ£€æµ‹åˆ°VentureBeat URLï¼Œä½¿ç”¨ä¸“é—¨çš„APIç«¯ç‚¹');
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('active');
            document.getElementById('result').classList.remove('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('fetchBtn').disabled = true;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'æŠ“å–å¤±è´¥');
                }

                if (data.success) {
                    displayResult(data.data);
                } else {
                    showError(data.message);
                }

            } catch (error) {
                showError('æŠ“å–å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('fetchBtn').disabled = false;
            }
        }

        function displayResult(data) {
            currentData = data;
            selectedImages = [];

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('result').classList.add('active');

            // å¡«å……åŸºæœ¬ä¿¡æ¯ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
            const resultTitleEl = document.getElementById('resultTitle');
            const crawlTimeEl = document.getElementById('crawlTime');
            const contentLengthEl = document.getElementById('contentLength');
            const imagesCountEl = document.getElementById('imagesCount');
            const contentPreviewEl = document.getElementById('contentPreview');
            const downloadContentEl = document.getElementById('downloadContent');
            const downloadMetadataEl = document.getElementById('downloadMetadata');
            
            if (resultTitleEl) resultTitleEl.textContent = data.title;
            if (crawlTimeEl) crawlTimeEl.textContent = new Date(data.crawl_time).toLocaleString('zh-CN');
            if (contentLengthEl) contentLengthEl.textContent = data.content_length.toLocaleString();
            if (imagesCountEl) imagesCountEl.textContent = data.images_count;
            if (contentPreviewEl) contentPreviewEl.textContent = data.content_preview;
            if (downloadContentEl) downloadContentEl.href = data.content_file;
            if (downloadMetadataEl) downloadMetadataEl.href = data.metadata_file;

            // æ˜¾ç¤ºå›¾ç‰‡
            const imagesGrid = document.getElementById('imagesGrid');
            imagesGrid.innerHTML = '';

            data.images.forEach((img, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';

                if (img.success) {
                    imageCard.innerHTML = `
                        <img src="${img.local_path}" alt="${img.alt || 'å›¾ç‰‡ ' + (index + 1)}" 
                             style="cursor:pointer;"
                             onclick="openImageModal(this.src, this)"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>åŠ è½½å¤±è´¥</text></svg>'">
                        <div class="status success">âœ“ å·²ä¸‹è½½</div>
                    `;
                } else {
                    imageCard.innerHTML = `
                        <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect fill='%23f5f5f5' width='200' height='200'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' fill='%23999'>ä¸‹è½½å¤±è´¥</text></svg>">
                        <div class="status error">âœ— å¤±è´¥</div>
                    `;
                }

                imagesGrid.appendChild(imageCard);
            });
            
            // æ˜¾ç¤ºè§†é¢‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const videosSection = document.getElementById('videosSection');
            const videosGrid = document.getElementById('videosGrid');
            
            if (data.videos && data.videos.length > 0 && videosSection && videosGrid) {
                videosSection.style.display = 'block';
                videosGrid.innerHTML = '';
                
                data.videos.forEach((video, index) => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'video-card';
                    videoCard.style.cssText = `
                        position: relative;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        transition: transform 0.2s;
                    `;
                    
                    if (video.success) {
                        videoCard.innerHTML = `
                            <div style="position: relative; cursor: pointer;" onclick="openVideoModal('${video.local_path}')">
                                <video src="${video.local_path}" muted style="width: 100%; height: 150px; object-fit: cover; display: block;"></video>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 50%; font-size: 16px;">â–¶ï¸</div>
                            </div>
                            <div style="padding: 10px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${video.filename}</div>
                                <div style="font-size: 12px; color: #888;">${video.size_mb ? video.size_mb.toFixed(1) + 'MB' : 'æœªçŸ¥å¤§å°'}</div>
                            </div>
                            <div class="status success" style="padding: 6px 10px; font-size: 12px;">âœ“ å·²ä¸‹è½½</div>
                        `;
                    } else {
                        videoCard.innerHTML = `
                            <div style="width: 100%; height: 150px; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999;">ä¸‹è½½å¤±è´¥</span>
                            </div>
                            <div style="padding: 10px;">
                                <div style="font-size: 12px; color: #888;">${video.error || 'ä¸‹è½½å¤±è´¥'}</div>
                            </div>
                            <div class="status error" style="padding: 6px 10px; font-size: 12px;">âœ— å¤±è´¥</div>
                        `;
                    }
                    
                    videosGrid.appendChild(videoCard);
                });
            } else if (videosSection) {
                videosSection.style.display = 'none';
            }

            // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
            setupEditSection(data);
        }

        function setupEditSection(data) {
            // åŠ è½½å®Œæ•´å†…å®¹åˆ°ç¼–è¾‘å™¨
            fetch(data.content_file)
                .then(response => response.text())
                .then(content => {
                    // ç§»é™¤å‰é¢çš„å…ƒæ•°æ®è¡Œ
                    const lines = content.split('\n');
                    const contentStart = lines.findIndex(line => line.includes('===='));
                    const actualContent = lines.slice(contentStart + 2).join('\n').trim();
                    document.getElementById('contentEditor').value = actualContent;
                })
                .catch(err => console.error('åŠ è½½å†…å®¹å¤±è´¥:', err));

            // åˆ›å»ºå¯é€‰æ‹©çš„å›¾ç‰‡å’Œè§†é¢‘
            const imageSelector = document.getElementById('imageSelector');
            imageSelector.innerHTML = '';

            // å¤„ç†å›¾ç‰‡
            const successImages = data.images.filter(img => img.success);
            successImages.forEach((img, index) => {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'selectable-image';
                imgDiv.dataset.index = index;
                imgDiv.dataset.path = img.local_path;
                imgDiv.dataset.type = 'image';
                
                imgDiv.innerHTML = `
                    <img src="${img.local_path}" alt="å›¾ç‰‡ ${index + 1}">
                    <div class="checkbox"></div>
                    <div class="image-order-number">${index + 1}</div>
                    ${img.local_path.toLowerCase().endsWith('.gif') ? '<div class="gif-badge">ğŸï¸ GIF</div>' : ''}
                    <div class="image-effects">
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'enhance', event)">å¢å¼º</button>
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'sharpen', event)">é”åŒ–</button>
                        <button class="effect-btn" onclick="openImageModal(this.closest('.selectable-image').dataset.path, this.closest('.selectable-image').querySelector('img')); event.stopPropagation();">ğŸ” æŸ¥çœ‹/å»æ°´å°</button>
                    </div>
                `;

                imgDiv.onclick = (e) => {
                    if (!e.target.classList.contains('effect-btn')) {
                        toggleMediaSelection(imgDiv);
                    }
                };

                imageSelector.appendChild(imgDiv);
            });

            // å¤„ç†è§†é¢‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (data.videos && data.videos.length > 0) {
                const successVideos = data.videos.filter(video => video.success);
                successVideos.forEach((video, index) => {
                    const videoIndex = successImages.length + index;
                    const videoDiv = document.createElement('div');
                    videoDiv.className = 'selectable-video';
                    videoDiv.dataset.index = videoIndex;
                    videoDiv.dataset.path = video.local_path;
                    videoDiv.dataset.type = 'video';
                    videoDiv.dataset.size = video.size_mb || 0;
                    
                    // ä»æ–‡ä»¶åæå–ç®€æ´åç§°
                    const fileName = video.filename || video.local_path.split('/').pop() || 'è§†é¢‘';
                    const displayName = fileName.length > 15 ? fileName.substring(0, 12) + '...' : fileName;
                    
                    videoDiv.innerHTML = `
                        ${video.thumbnail_path ? 
                            `<img src="${video.thumbnail_path}" alt="è§†é¢‘ç¼©ç•¥å›¾" style="width: 100%; height: 100%; object-fit: cover; display: block;">` :
                            `<div class="video-preview">ğŸ¬</div>`
                        }
                        <div class="video-info">
                            <div>${displayName}</div>
                            <div>${video.size_mb ? video.size_mb.toFixed(1) + 'MB' : 'æœªçŸ¥å¤§å°'}</div>
                        </div>
                        <div class="checkbox"></div>
                        <div class="image-order-number">${videoIndex + 1}</div>
                        <div class="gif-badge">ğŸ¥ è§†é¢‘</div>
                    `;

                    videoDiv.onclick = (e) => {
                        toggleMediaSelection(videoDiv);
                    };

                    imageSelector.appendChild(videoDiv);
                });
            }

            // æ˜¾ç¤ºç¼–è¾‘åŒºåŸŸ
            document.getElementById('editSection').classList.add('active');
            document.getElementById('aiSummary').style.display = 'none';
        }

        function toggleMediaSelection(mediaDiv) {
            const index = parseInt(mediaDiv.dataset.index);
            const path = mediaDiv.dataset.path;
            const type = mediaDiv.dataset.type;

            if (mediaDiv.classList.contains('selected')) {
                mediaDiv.classList.remove('selected');
                selectedImages = selectedImages.filter(i => i !== path);
                console.log(`å–æ¶ˆé€‰æ‹©${type}:`, path);
            } else {
                mediaDiv.classList.add('selected');
                selectedImages.push(path);
                console.log(`é€‰æ‹©${type}:`, path);
            }

            console.log('å½“å‰å·²é€‰æ‹©åª’ä½“:', selectedImages.length);
            
            // æ›´æ–°æ’åºé¢æ¿
            initSortPanel();
            // æ›´æ–°ä¸»å›¾ç‰‡åŒºåŸŸåºå·
            setTimeout(updateMainImageNumbers, 100);
        }

        function toggleImageSelection(imgDiv) {
            // ä¿æŒå‘åå…¼å®¹
            toggleMediaSelection(imgDiv);
        }

        // å¤„ç†æœ¬åœ°å›¾ç‰‡ä¸Šä¼ 
        async function handleLocalImageUpload(event) {
            const files = event.target.files;
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (files.length === 0) return;
            
            uploadStatus.innerHTML = `æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`;
            
            try {
                const uploadedPaths = [];
                
                // é€ä¸ªå¤„ç†æ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('image/')) {
                        showToast(`æ–‡ä»¶ ${file.name} ä¸æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼`, 'error');
                        continue;
                    }
                    
                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
                    if (file.size > 10 * 1024 * 1024) {
                        showToast(`æ–‡ä»¶ ${file.name} å¤ªå¤§ï¼ˆè¶…è¿‡10MBï¼‰`, 'error');
                        continue;
                    }
                    
                    // åˆ›å»ºFormData
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    try {
                        const response = await fetch('/upload-local-image', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            uploadedPaths.push(result.image_path);
                            showToast(`âœ… ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success', 2000);
                        } else {
                            showToast(`âŒ ${file.name} ä¸Šä¼ å¤±è´¥: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showToast(`âŒ ${file.name} ä¸Šä¼ å‡ºé”™: ${error.message}`, 'error');
                    }
                }
                
                // å°†ä¸Šä¼ çš„å›¾ç‰‡æ·»åŠ åˆ°é€‰æ‹©åŒºåŸŸ
                if (uploadedPaths.length > 0) {
                    addUploadedImagesToSelector(uploadedPaths);
                    uploadStatus.innerHTML = `âœ… æˆåŠŸä¸Šä¼  ${uploadedPaths.length} ä¸ªæ–‡ä»¶`;
                    
                    // 3ç§’åæ¸…é™¤çŠ¶æ€
                    setTimeout(() => {
                        uploadStatus.innerHTML = '';
                    }, 3000);
                } else {
                    uploadStatus.innerHTML = 'âŒ æ²¡æœ‰æ–‡ä»¶æˆåŠŸä¸Šä¼ ';
                }
                
            } catch (error) {
                console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                showToast('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
                uploadStatus.innerHTML = 'âŒ ä¸Šä¼ å¤±è´¥';
            }
            
            // æ¸…ç©ºinputä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©ç›¸åŒæ–‡ä»¶
            event.target.value = '';
        }

        // å°†ä¸Šä¼ çš„å›¾ç‰‡æ·»åŠ åˆ°é€‰æ‹©å™¨
        function addUploadedImagesToSelector(imagePaths) {
            const imageSelector = document.getElementById('imageSelector');
            
            imagePaths.forEach((imagePath, index) => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingImage = Array.from(imageSelector.querySelectorAll('.selectable-image'))
                    .find(img => img.dataset.path === imagePath);
                
                if (existingImage) {
                    return; // å·²å­˜åœ¨ï¼Œè·³è¿‡
                }
                
                // åˆ›å»ºæ–°çš„å›¾ç‰‡å…ƒç´ 
                const imgDiv = document.createElement('div');
                imgDiv.className = 'selectable-image';
                imgDiv.dataset.path = imagePath;
                imgDiv.dataset.type = 'image';
                imgDiv.dataset.source = 'local'; // æ ‡è®°ä¸ºæœ¬åœ°ä¸Šä¼ 
                
                // ç”Ÿæˆå”¯ä¸€çš„ç´¢å¼•ï¼ˆåŸºäºç°æœ‰å›¾ç‰‡æ•°é‡ï¼‰
                const existingImages = imageSelector.querySelectorAll('.selectable-image').length;
                imgDiv.dataset.index = existingImages + index;
                
                imgDiv.innerHTML = `
                    <img src="${imagePath}" alt="æœ¬åœ°ä¸Šä¼ å›¾ç‰‡ ${existingImages + index + 1}" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%23f5f5f5%22 width=%22200%22 height=%22200%22/><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>åŠ è½½å¤±è´¥</text></svg>'">
                    <div class="checkbox"></div>
                    <div class="image-order-number">${existingImages + index + 1}</div>
                    <div class="local-upload-badge">ğŸ“± æœ¬åœ°ä¸Šä¼ </div>
                    <div class="image-effects">
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'enhance', event)">å¢å¼º</button>
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'sharpen', event)">é”åŒ–</button>
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'grayscale', event)">é»‘ç™½</button>
                        <button class="effect-btn" onclick="processImage(this.closest('.selectable-image').dataset.path, 'blur', event)">æ¨¡ç³Š</button>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                imgDiv.onclick = (e) => {
                    // é˜»æ­¢æ•ˆæœæŒ‰é’®çš„äº‹ä»¶å†’æ³¡
                    if (e.target.classList.contains('effect-btn')) return;
                    toggleMediaSelection(imgDiv);
                };
                
                // æ·»åŠ åˆ°é€‰æ‹©å™¨
                imageSelector.appendChild(imgDiv);
            });
        }

        async function processImage(imagePath, effect, event) {
            event.stopPropagation();
            
            try {
                const response = await fetch('/api/process-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_path: imagePath,
                        effect: effect
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`å›¾ç‰‡å¤„ç†æˆåŠŸï¼\næ•ˆæœ: ${effect}\nä¿å­˜ä½ç½®: ${data.processed_path}`);
                    // å¯ä»¥é€‰æ‹©æ›´æ–°é¢„è§ˆ
                } else {
                    alert('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        async function generateSummary() {
            const content = document.getElementById('contentEditor').value;
            
            if (!content.trim()) {
                alert('è¯·å…ˆè¾“å…¥æˆ–ç¼–è¾‘æ–‡ç« å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
            const summaryDiv = document.getElementById('aiSummary');
            if (summaryDiv) summaryDiv.style.display = 'block';
            
            const aiMainTitleEl = document.getElementById('editableMainTitle');
            const aiSubTitleEl = document.getElementById('editableSubTitle');
            const aiSummaryEl = document.getElementById('editableAiSummary');
            const aiTagsEl = document.getElementById('editableAiTags');
            const aiMetaEl = document.getElementById('aiMeta');
            
            if (aiMainTitleEl) aiMainTitleEl.value = 'æ­£åœ¨ç”Ÿæˆä¸»æ ‡é¢˜...';
            if (aiSubTitleEl) aiSubTitleEl.value = 'æ­£åœ¨ç”Ÿæˆå‰¯æ ‡é¢˜...';
            if (aiSummaryEl) aiSummaryEl.value = 'æ­£åœ¨ç”Ÿæˆæ‘˜è¦...';
            if (aiTagsEl) aiTagsEl.value = '';
            if (aiMetaEl) aiMetaEl.textContent = '';

            try {
                const response = await fetch('/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        images: selectedImages,
                        title: currentData.title
                    })
                });

                const data = await response.json();

                if (data.success) {
                    generatedTitle = data.title;
                    generatedSummary = data.summary;
                    
                    // æ˜¾ç¤ºä¸»å‰¯æ ‡é¢˜åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†
                    const mainT = data.main_title || data.title.split('|')[0];
                    const subT = data.sub_title || (data.title.includes('|') ? data.title.split('|')[1] : '');
                    
                    document.getElementById('editableMainTitle').value = mainT;
                    document.getElementById('editableSubTitle').value = subT;
                    document.getElementById('editableAiSummary').value = data.summary;
                    document.getElementById('editableAiTags').value = data.tags || '';
                    document.getElementById('aiMeta').textContent = 
                        `ä¸»æ ‡é¢˜: ${mainT.length}å­— | å‰¯æ ‡é¢˜: ${subT.length}å­— | æ‘˜è¦: ${data.summary.length}å­— | æ¨¡å‹: ${data.model} | tokens: ${data.tokens_used}`;
                    
                    // è‡ªåŠ¨ä¿å­˜åˆå§‹å†…å®¹
                    saveEditedContent();
                } else {
                    if (aiMainTitleEl) aiMainTitleEl.value = '';
                    if (aiSubTitleEl) aiSubTitleEl.value = '';
                    if (aiSummaryEl) aiSummaryEl.value = 'ç”Ÿæˆå¤±è´¥: ' + data.message;
                    if (aiTagsEl) aiTagsEl.value = '';
                    if (aiMetaEl) aiMetaEl.textContent = '';
                }
            } catch (error) {
                if (aiMainTitleEl) aiMainTitleEl.value = '';
                if (aiSubTitleEl) aiSubTitleEl.value = '';
                if (aiSummaryEl) aiSummaryEl.value = 'ç”Ÿæˆå¤±è´¥: ' + error.message;
                if (aiTagsEl) aiTagsEl.value = '';
                if (aiMetaEl) aiMetaEl.textContent = '';
            }
        }

        async function generateVideoDirectly() {
            // æ£€æŸ¥å¿…è¦æ¡ä»¶
            const mainTitle = document.getElementById('editableMainTitle')?.value.trim();
            const subTitle = document.getElementById('editableSubTitle')?.value.trim();
            const editedSummary = document.getElementById('editableAiSummary')?.value.trim();
            
            if (!mainTitle || !editedSummary) {
                showToast('è¯·å…ˆç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦ï¼Œæˆ–æ‰‹åŠ¨å¡«å†™å†…å®¹', 'error');
                return;
            }
            
            // ç»„åˆæ ‡é¢˜
            const editedTitle = subTitle ? `${mainTitle}|${subTitle}` : mainTitle;
            
            if (selectedImages.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰GIFæˆ–è§†é¢‘éœ€è¦ç‰¹æ®Šå¤„ç†
            const gifImages = selectedImages.filter(path => path.toLowerCase().endsWith('.gif'));
            const videoFiles = selectedImages.filter(path => 
                path.toLowerCase().endsWith('.mp4') || 
                path.toLowerCase().endsWith('.webm') || 
                path.toLowerCase().endsWith('.mov')
            );
            
            // ä¸å†è¿‡æ»¤è§†é¢‘æ–‡ä»¶ï¼Œç°åœ¨æ”¯æŒè§†é¢‘åµŒå…¥
            const mediaFiles = selectedImages;
            
            if (mediaFiles.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåª’ä½“æ–‡ä»¶ï¼ˆå›¾ç‰‡æˆ–è§†é¢‘ï¼‰', 'error');
                return;
            }
            
            if (gifImages.length > 0 || videoFiles.length > 0) {
                let message = '';
                if (gifImages.length > 0) {
                    message += `æ£€æµ‹åˆ° ${gifImages.length} ä¸ªGIFå›¾ç‰‡`;
                }
                if (videoFiles.length > 0) {
                    message += `${message ? ' å’Œ ' : 'æ£€æµ‹åˆ° '}${videoFiles.length} ä¸ªè§†é¢‘æ–‡ä»¶`;
                }
                message += 'ï¼Œæ­£åœ¨å¤„ç†...';
                showToast(message, 'info');
                
                // å¤„ç†GIF
                if (gifImages.length > 0) {
                    const gifVideos = await processSelectedGIFs(2.7); // 2.7ç§’æ¯å¸§
                    if (gifVideos.length > 0) {
                        showToast(`âœ… å·²å¤„ç† ${gifVideos.length} ä¸ªGIFä¸ºè§†é¢‘ç‰‡æ®µ`, 'success');
                    }
                }
                
                // è§†é¢‘æ–‡ä»¶ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨
                if (videoFiles.length > 0) {
                    showToast(`ğŸ¬ ${videoFiles.length} ä¸ªè§†é¢‘æ–‡ä»¶å°†ä½œä¸ºç”»ä¸­ç”»æ•ˆæœåµŒå…¥`, 'success');
                }
            }
            
            showToast('ğŸš€ æ­£åœ¨ç”Ÿæˆè§†é¢‘ï¼Œè¯·ç¨å€™...', 'info');
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progressContainer = document.createElement('div');
            progressContainer.id = 'videoProgress';
            progressContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 300px;
            `;
            
            progressContainer.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea;">ğŸ¬ æ­£åœ¨ç”Ÿæˆè§†é¢‘</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 20px;">è¯·è€å¿ƒç­‰å¾…ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åç§’...</div>
                <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <div id="progressText" style="font-size: 12px; color: #888; margin-top: 10px;">å‡†å¤‡ä¸­...</div>
                <button id="cancelVideoBtn" style="margin-top: 15px; padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">å–æ¶ˆ</button>
            `;
            
            document.body.appendChild(progressContainer);
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress = Math.min(progress + Math.random() * 15, 90);
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                if (progressBar) progressBar.style.width = `${progress}%`;
                if (progressText) {
                    if (progress < 30) {
                        progressText.textContent = 'æ­£åœ¨å¤„ç†å›¾ç‰‡...';
                    } else if (progress < 60) {
                        progressText.textContent = 'æ­£åœ¨åˆæˆè§†é¢‘...';
                    } else if (progress < 90) {
                        progressText.textContent = 'æ­£åœ¨æ·»åŠ éŸ³é¢‘...';
                    } else {
                        progressText.textContent = 'å³å°†å®Œæˆ...';
                    }
                }
            }, 800);
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancelVideoBtn').onclick = () => {
                clearInterval(progressInterval);
                document.body.removeChild(progressContainer);
                showToast('è§†é¢‘ç”Ÿæˆå·²å–æ¶ˆ', 'info');
            };
            
            try {
                // ç›´æ¥è°ƒç”¨åˆ›å»ºå¸¦åŠ¨ç”»è§†é¢‘çš„API
                const response = await fetch('/api/create-animated-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: getCombinedTitle(),
                        subtitle: editedSubTitle,
                        summary: editedSummary,
                        images: mediaFiles,  // ä½¿ç”¨æ‰€æœ‰åª’ä½“æ–‡ä»¶ï¼ˆåŒ…æ‹¬è§†é¢‘ï¼‰
                        audio_path: 'static/music/background.mp3'
                    })
                });
                
                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);
                console.log('è§†é¢‘è·¯å¾„:', data.video_path);
                
                if (data.success) {
                    // éšè—è¿›åº¦æ¡
                    clearInterval(progressInterval);
                    const progressBarFinal = document.getElementById('progressBar');
                    if (progressBarFinal) progressBarFinal.style.width = '100%';
                    const progressTextFinal = document.getElementById('progressText');
                    if (progressTextFinal) progressTextFinal.textContent = 'å®Œæˆ!';
                    
                    setTimeout(() => {
                        if (document.getElementById('videoProgress')) {
                            document.body.removeChild(document.getElementById('videoProgress'));
                        }
                    }, 1000);
                    
                    // æ˜¾ç¤ºè§†é¢‘ç»“æœ
                    const videoResultEl = document.getElementById('videoResult');
                    const videoInfoEl = document.getElementById('videoInfo');
                    const generatedVideoEl = document.getElementById('generatedVideo');
                    const downloadBtnEl = document.getElementById('downloadVideoBtn');
                    const generatedImageEl = document.getElementById('generatedImage'); // è·å–çˆ¶å®¹å™¨
                    
                    console.log('DOMå…ƒç´ æ£€æŸ¥:');
                    console.log('- videoResultEl:', videoResultEl);
                    console.log('- videoInfoEl:', videoInfoEl);
                    console.log('- generatedVideoEl:', generatedVideoEl);
                    console.log('- downloadBtnEl:', downloadBtnEl);
                    console.log('- generatedImageEl:', generatedImageEl);
                    
                    // é¦–å…ˆæ˜¾ç¤ºçˆ¶å®¹å™¨
                    if (generatedImageEl) {
                        generatedImageEl.style.display = 'block';
                        console.log('âœ… çˆ¶å®¹å™¨ generatedImage å·²æ˜¾ç¤º');
                    }
                    
                    if (videoResultEl) {
                        videoResultEl.style.display = 'block';
                        console.log('è§†é¢‘ç»“æœåŒºåŸŸå·²æ˜¾ç¤º');
                        
                        // å¼ºåˆ¶åˆ·æ–°æ ·å¼
                        videoResultEl.style.visibility = 'visible';
                        videoResultEl.style.opacity = '1';
                        videoResultEl.style.height = 'auto';
                        
                        // æ·»åŠ æ˜æ˜¾çš„è§†è§‰æ ‡è®°
                        videoResultEl.style.border = '3px solid #667eea';
                        videoResultEl.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
                        videoResultEl.style.zIndex = '9999';
                        videoResultEl.style.position = 'relative';
                        
                        // æ£€æŸ¥å®¹å™¨å°ºå¯¸
                        console.log('è§†é¢‘å®¹å™¨å°ºå¯¸:', {
                            offsetWidth: videoResultEl.offsetWidth,
                            offsetHeight: videoResultEl.offsetHeight,
                            clientWidth: videoResultEl.clientWidth,
                            clientHeight: videoResultEl.clientHeight
                        });
                        
                        // æ£€æŸ¥çˆ¶å…ƒç´ 
                        let parent = videoResultEl.parentElement;
                        let level = 0;
                        while (parent && level < 5) {
                            console.log(`çˆ¶å…ƒç´ ${level}:`, parent.tagName, parent.style.display, parent.style.visibility);
                            parent = parent.parentElement;
                            level++;
                        }
                        
                        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                        videoResultEl.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    if (videoInfoEl) {
                        videoInfoEl.innerHTML = `
                            <span>ğŸ¬ æ—¶é•¿: ${data.duration.toFixed(1)}ç§’</span>
                            <span>ğŸ“¦ å¤§å°: ${data.file_size_mb}MB</span>
                            <span>ğŸ–¼ï¸ åª’ä½“: ${mediaFiles.length}ä¸ªæ–‡ä»¶</span>
                            ${videoFiles.length > 0 ? `<span style="color: #4CAF50;">âœ… åŒ…å«${videoFiles.length}ä¸ªè§†é¢‘ç”»ä¸­ç”»</span>` : ''}
                        `;
                        console.log('è§†é¢‘ä¿¡æ¯å·²æ›´æ–°');
                    }
                    
                    if (generatedVideoEl) {
                        console.log('è®¾ç½®è§†é¢‘æº:', data.video_path);
                        generatedVideoEl.src = data.video_path;
                        generatedVideoEl.load();
                        
                        // å¼ºåˆ¶è®¾ç½®è§†é¢‘å…ƒç´ æ ·å¼
                        generatedVideoEl.style.display = 'block';
                        generatedVideoEl.style.visibility = 'visible';
                        generatedVideoEl.style.opacity = '1';
                        
                        // æ·»åŠ è§†è§‰æ ‡è®°
                        generatedVideoEl.style.border = '2px dashed #764ba2';
                        
                        // æ·»åŠ é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
                        console.log('è§†é¢‘å…ƒç´ å®Œæ•´ä¿¡æ¯:', {
                            tagName: generatedVideoEl.tagName,
                            id: generatedVideoEl.id,
                            className: generatedVideoEl.className,
                            src: generatedVideoEl.src,
                            currentSrc: generatedVideoEl.currentSrc,
                            readyState: generatedVideoEl.readyState,
                            networkState: generatedVideoEl.networkState,
                            videoWidth: generatedVideoEl.videoWidth,
                            videoHeight: generatedVideoEl.videoHeight
                        });
                        
                        console.log('è§†é¢‘å…ƒç´ æ ·å¼:', {
                            display: generatedVideoEl.style.display,
                            visibility: generatedVideoEl.style.visibility,
                            opacity: generatedVideoEl.style.opacity,
                            width: generatedVideoEl.style.width,
                            maxWidth: generatedVideoEl.style.maxWidth
                        });
                        
                        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ¥è°ƒè¯•
                        generatedVideoEl.addEventListener('loadeddata', function() {
                            console.log('âœ… è§†é¢‘æ•°æ®åŠ è½½å®Œæˆ');
                            console.log('è§†é¢‘å…ƒç´ çŠ¶æ€:', generatedVideoEl.readyState);
                        });
                        
                        generatedVideoEl.addEventListener('canplay', function() {
                            console.log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾');
                        });
                        
                        generatedVideoEl.addEventListener('error', function(e) {
                            console.error('âŒ è§†é¢‘åŠ è½½é”™è¯¯:', e);
                            console.error('è§†é¢‘å…ƒç´ é”™è¯¯ä¿¡æ¯:', generatedVideoEl.error);
                            if (generatedVideoEl.error) {
                                console.error('é”™è¯¯ä»£ç :', generatedVideoEl.error.code);
                                console.error('é”™è¯¯ä¿¡æ¯:', generatedVideoEl.error.message);
                            }
                        });
                        
                        // æµ‹è¯•æ˜¯å¦èƒ½æ’­æ”¾
                        setTimeout(() => {
                            if (generatedVideoEl.readyState >= 2) {
                                console.log('âœ… è§†é¢‘å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾');
                                // å°è¯•æ’­æ”¾æµ‹è¯•
                                try {
                                    generatedVideoEl.play().then(() => {
                                        console.log('âœ… è§†é¢‘å¼€å§‹æ’­æ”¾');
                                        setTimeout(() => {
                                            generatedVideoEl.pause();
                                            console.log('â¹ï¸ è§†é¢‘æš‚åœæµ‹è¯•');
                                        }, 1000);
                                    }).catch(e => {
                                        console.log('â„¹ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆæ­£å¸¸ï¼‰:', e);
                                    });
                                } catch(e) {
                                    console.log('â„¹ï¸ æ’­æ”¾æµ‹è¯•å¼‚å¸¸:', e);
                                }
                            } else {
                                console.warn('âš ï¸ è§†é¢‘è¿˜æœªå‡†å¤‡å¥½æ’­æ”¾ï¼Œå½“å‰çŠ¶æ€:', generatedVideoEl.readyState);
                            }
                        }, 2000);
                    }
                    
                    if (downloadBtnEl) {
                        downloadBtnEl.href = data.video_path;
                        downloadBtnEl.download = `video_${new Date().getTime()}.mp4`;
                    }
                    
                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    if (videoResultEl) {
                        videoResultEl.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    showToast(`ğŸ‰ è§†é¢‘ç”ŸæˆæˆåŠŸï¼æ—¶é•¿ ${data.duration.toFixed(1)}ç§’`, 'success', 5000);
                } else {
                    // éšè—è¿›åº¦æ¡
                    clearInterval(progressInterval);
                    if (document.getElementById('videoProgress')) {
                        document.body.removeChild(document.getElementById('videoProgress'));
                    }
                    
                    showToast('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                // éšè—è¿›åº¦æ¡
                clearInterval(progressInterval);
                if (document.getElementById('videoProgress')) {
                    document.body.removeChild(document.getElementById('videoProgress'));
                }
                
                console.error('è§†é¢‘ç”Ÿæˆé”™è¯¯:', error);
                showToast('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function generateVideoImage() {
            if (!generatedTitle || !generatedSummary) {
                alert('è¯·å…ˆç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦');
                return;
            }

            if (selectedImages.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰GIFéœ€è¦ç‰¹æ®Šå¤„ç†
            const gifImages = selectedImages.filter(path => path.toLowerCase().endsWith('.gif'));
            
            if (gifImages.length > 0) {
                showToast(`æ£€æµ‹åˆ° ${gifImages.length} ä¸ªGIFå›¾ç‰‡ï¼Œæ­£åœ¨é¢„å¤„ç†...`, 'info');
                
                // å¤„ç†GIFä¸ºè§†é¢‘ç‰‡æ®µ
                const gifVideos = await processSelectedGIFs(2.5); // é»˜è®¤2.5ç§’
                if (gifVideos.length > 0) {
                    showToast(`âœ… å·²å¤„ç† ${gifVideos.length} ä¸ªGIFä¸ºè§†é¢‘ç‰‡æ®µ`, 'success');
                    // è¿™é‡Œå¯ä»¥å°†å¤„ç†åçš„è§†é¢‘è·¯å¾„åˆå¹¶åˆ°selectedImagesä¸­
                    // æˆ–è€…å•ç‹¬å¤„ç†å®ƒä»¬
                }
            }

            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: getCombinedTitle(),
                        subtitle: editedSubTitle || '',
                        summary: editedSummary || generatedSummary,
                        images: selectedImages
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„å…³é”®å¸§ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
                    const generatedImageEl = document.getElementById('generatedImage');
                    const framesInfoEl = document.getElementById('framesInfo');
                    const framesContainer = document.getElementById('framesContainer');
                    const createVideoBtn = document.getElementById('createVideoBtn');
                    
                    if (generatedImageEl) generatedImageEl.style.display = 'block';
                    if (framesInfoEl) framesInfoEl.textContent = 
                        `âœ… ${data.message} | æ ‡é¢˜: ${data.title} | æ‘˜è¦: ${data.summary.substring(0, 30)}...`;
                    
                    if (framesContainer) {
                        framesContainer.innerHTML = '';
                        
                        // ä¿å­˜ç”Ÿæˆçš„å¸§ç›®å½•è·¯å¾„ï¼Œç”¨äºåç»­è§†é¢‘åˆæˆ
                        window.generatedFramesDir = data.output_dir;
                        
                        // æ˜¾ç¤ºæ¯ä¸€å¸§
                        data.frames.forEach(frame => {
                            const frameCard = document.createElement('div');
                            frameCard.style.cssText = 'background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                            
                            frameCard.innerHTML = `
                                <div style="font-weight: bold; color: #667eea; margin-bottom: 8px;">
                                    å…³é”®å¸§ ${frame.frame_index}
                                </div>
                                <img src="${frame.image_path}" 
                                     style="width: 100%; border-radius: 4px; cursor: pointer;" 
                                     onclick="openImageModal(this.src, this)">
                                <div style="margin-top: 8px; display: flex; gap: 8px;">
                                    <a href="${frame.image_path}" download="frame_${frame.frame_index}.png" 
                                       class="download-btn" style="flex: 1; text-align: center; padding: 8px 12px; font-size: 13px;">
                                        ğŸ“¥ ä¸‹è½½
                                    </a>
                                </div>
                            `;
                            
                            framesContainer.appendChild(frameCard);
                        });
                    }
                    
                    // æ˜¾ç¤ºåˆæˆè§†é¢‘æŒ‰é’®
                    if (createVideoBtn) createVideoBtn.style.display = 'inline-block';
                    
                    showToast(`è§†é¢‘å…³é”®å¸§ç”ŸæˆæˆåŠŸï¼å…± ${data.total} å¸§`, 'success');
                } else {
                    showToast('å…³é”®å¸§ç”Ÿæˆå¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('å…³é”®å¸§ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function createVideo() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç”Ÿæˆçš„è§†é¢‘å¸§ç›®å½•
            if (!window.generatedFramesDir) {
                showToast('è¯·å…ˆç”Ÿæˆè§†é¢‘å…³é”®å¸§', 'error');
                console.error('window.generatedFramesDir is undefined');
                return;
            }
            
            console.log('ä½¿ç”¨çš„å…³é”®å¸§ç›®å½•:', window.generatedFramesDir);
            
            const btn = document.getElementById('createVideoBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ¬ æ­£åœ¨åˆæˆè§†é¢‘...';
            
            try {
                const response = await fetch('/api/create-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frames_dir: window.generatedFramesDir,
                        duration_per_frame: 2.5,
                        audio_path: 'static/music/background.mp3'  // èƒŒæ™¯éŸ³ä¹
                    })
                });
                
                const data = await response.json();
                console.log('è§†é¢‘ç”Ÿæˆå“åº”:', data);
                
                if (data.success) {
                    // æ˜¾ç¤ºè§†é¢‘ç»“æœï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
                    const videoResult = document.getElementById('videoResult');
                    const videoInfo = document.getElementById('videoInfo');
                    const videoPlayer = document.getElementById('generatedVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');
                    
                    if (videoInfo) videoInfo.textContent = `ğŸ¬ å…³é”®å¸§: ${data.frames_count} | æ—¶é•¿: ${data.duration.toFixed(1)}ç§’ | å¤§å°: ${data.file_size_mb}MB`;
                    if (videoPlayer) videoPlayer.src = data.video_path;
                    if (downloadBtn) {
                        downloadBtn.href = data.video_path;
                        downloadBtn.download = data.video_path.split('/').pop();
                    }
                    if (videoResult) videoResult.style.display = 'block';
                    
                    showToast(`è§†é¢‘ç”ŸæˆæˆåŠŸï¼æ—¶é•¿ ${data.duration.toFixed(1)}ç§’ï¼Œå¤§å° ${data.file_size_mb}MB`, 'success', 4500);
                } else {
                    showToast('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                // éšè—è¿›åº¦æ¡
                clearInterval(progressInterval);
                if (document.getElementById('videoProgress')) {
                    document.body.removeChild(document.getElementById('videoProgress'));
                }
                
                console.error('è§†é¢‘ç”Ÿæˆé”™è¯¯:', error);
                showToast('è§†é¢‘ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¬ åˆæˆè§†é¢‘ (å¸¦èƒŒæ™¯éŸ³ä¹)';
            }
        }

        async function oneClickGenerate() {
            const btn = document.getElementById('oneClickBtn');
            const originalText = btn.textContent;
            btn.disabled = true;

            const content = document.getElementById('contentEditor').value;
            if (!content.trim()) {
                showToast('è¯·å…ˆæŠ“å–ç½‘é¡µå†…å®¹', 'error');
                btn.disabled = false;
                return;
            }

            // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨é€‰æ‹©å›¾ç‰‡ï¼Œè‡ªåŠ¨é€‰æ‹©å‰5å¼ 
            if (selectedImages.length === 0) {
                const allImgs = document.querySelectorAll('.selectable-image');
                const maxAuto = Math.min(allImgs.length, 5);
                for (let i = 0; i < maxAuto; i++) {
                    if (!allImgs[i].classList.contains('selected')) {
                        toggleImageSelection(allImgs[i]);
                    }
                }
                if (selectedImages.length === 0) {
                    showToast('æ²¡æœ‰å¯ç”¨çš„å›¾ç‰‡', 'error');
                    btn.disabled = false;
                    return;
                }
                showToast(`å·²è‡ªåŠ¨é€‰æ‹© ${selectedImages.length} å¼ å›¾ç‰‡`, 'info');
            }

            try {
                // ç¬¬1æ­¥ï¼šç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦
                btn.textContent = 'ğŸš€ [1/2] ç”Ÿæˆæ ‡é¢˜æ‘˜è¦...';
                showToast('å¼€å§‹ä¸€é”®ç”Ÿæˆï¼šæ­£åœ¨ç”ŸæˆAIæ ‡é¢˜å’Œæ‘˜è¦...', 'info');

                const summaryDiv = document.getElementById('aiSummary');
                if (summaryDiv) summaryDiv.style.display = 'block';
                
                // ä½¿ç”¨æ–°çš„å¯ç¼–è¾‘è¾“å…¥æ¡†IDï¼ˆé¿å…å˜é‡åå†²çªï¼‰
                const oneClickMainTitleEl = document.getElementById('editableMainTitle');
                const oneClickSubTitleEl = document.getElementById('editableSubTitle');
                const oneClickSummaryEl = document.getElementById('editableAiSummary');
                
                if (oneClickMainTitleEl) oneClickMainTitleEl.value = 'æ­£åœ¨ç”Ÿæˆä¸»æ ‡é¢˜...';
                if (oneClickSubTitleEl) oneClickSubTitleEl.value = 'æ­£åœ¨ç”Ÿæˆå‰¯æ ‡é¢˜...';
                if (oneClickSummaryEl) oneClickSummaryEl.value = 'æ­£åœ¨ç”Ÿæˆæ‘˜è¦...';

                const summaryResp = await fetch('/api/generate-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        images: selectedImages,
                        title: currentData ? currentData.title : ''
                    })
                });
                const summaryData = await summaryResp.json();

                if (!summaryData.success) {
                    showToast('æ ‡é¢˜æ‘˜è¦ç”Ÿæˆå¤±è´¥: ' + summaryData.message, 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }

                generatedTitle = summaryData.title;
                generatedSummary = summaryData.summary;
                const mainT2 = summaryData.main_title || summaryData.title.split('|')[0];
                const subT2 = summaryData.sub_title || (summaryData.title.includes('|') ? summaryData.title.split('|')[1] : '');
                const combinedTitle2 = subT2 ? `${mainT2}|${subT2}` : mainT2;
                
                // å¡«å……åˆ°å¯ç¼–è¾‘è¾“å…¥æ¡†ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
                const aiMainTitleEl = document.getElementById('editableMainTitle');
                const aiSubTitleEl = document.getElementById('editableSubTitle');
                const aiSummaryEl = document.getElementById('editableAiSummary');
                const aiTagsEl = document.getElementById('editableAiTags');
                const aiMetaEl = document.getElementById('aiMeta');
                
                if (aiMainTitleEl) aiMainTitleEl.value = mainT2;
                if (aiSubTitleEl) aiSubTitleEl.value = subT2;
                if (aiSummaryEl) aiSummaryEl.value = summaryData.summary;
                if (aiTagsEl) aiTagsEl.value = summaryData.tags || '';
                if (aiMetaEl) aiMetaEl.textContent =
                    `ä¸»æ ‡é¢˜: ${mainT2.length}å­— | å‰¯æ ‡é¢˜: ${subT2.length}å­— | æ‘˜è¦: ${summaryData.summary.length}å­— | æ¨¡å‹: ${summaryData.model} | tokens: ${summaryData.tokens_used}`;
                
                // è‡ªåŠ¨ä¿å­˜å†…å®¹
                saveEditedContent();

                showToast('âœ… æ ‡é¢˜æ‘˜è¦å·²ç”Ÿæˆï¼Œå¼€å§‹åˆæˆåŠ¨ç”»è§†é¢‘...', 'success');

                // ç¬¬2æ­¥ï¼šåˆæˆåŠ¨ç”»è§†é¢‘ï¼ˆå¸¦å¼¹å…¥ç‰¹æ•ˆï¼‰
                btn.textContent = 'ğŸš€ [2/2] åˆæˆåŠ¨ç”»è§†é¢‘...';

                const videoResp = await fetch('/api/create-animated-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: combinedTitle2 || generatedTitle,
                        summary: editedSummary || generatedSummary,
                        images: selectedImages,
                        audio_path: 'static/music/background.mp3'
                    })
                });
                const videoData = await videoResp.json();

                if (videoData.success) {
                    // æ˜¾ç¤ºé¢„è§ˆå¸§ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
                    const generatedImageEl = document.getElementById('generatedImage');
                    const framesInfoEl = document.getElementById('framesInfo');
                    
                    if (generatedImageEl) generatedImageEl.style.display = 'block';
                    if (framesInfoEl) framesInfoEl.textContent =
                        `âœ… åŠ¨ç”»è§†é¢‘å·²ç”Ÿæˆ | ç‰‡æ®µ: ${videoData.preview_frames.length} | æ ‡é¢˜: ${generatedTitle}`;
                    
                    // æ˜¾ç¤ºé¢„è§ˆå¸§
                    if (videoData.preview_frames && videoData.preview_frames.length > 0) {
                        const framesContainer = document.getElementById('framesContainer');
                        if (framesContainer) {
                            framesContainer.innerHTML = '';
                            videoData.preview_frames.forEach((framePath, i) => {
                                const frameCard = document.createElement('div');
                                frameCard.style.cssText = 'background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                                frameCard.innerHTML = `
                                    <div style="font-weight: bold; color: #667eea; margin-bottom: 8px;">ç‰‡æ®µ ${i + 1} é¢„è§ˆ</div>
                                    <img src="${framePath}" style="width: 100%; border-radius: 4px; cursor: pointer;" onclick="openImageModal(this.src, this)">
                                `;
                                framesContainer.appendChild(frameCard);
                            });
                        }
                    }

                    const videoResult = document.getElementById('videoResult');
                    const videoInfo = document.getElementById('videoInfo');
                    const videoPlayer = document.getElementById('generatedVideo');
                    const downloadBtn = document.getElementById('downloadVideoBtn');

                    if (videoInfo) videoInfo.textContent = `ğŸ¬ ç‰‡æ®µ: ${videoData.preview_frames ? videoData.preview_frames.length : '?'} | æ—¶é•¿: ${videoData.duration.toFixed(1)}ç§’ | å¤§å°: ${videoData.file_size_mb}MB`;
                    if (videoPlayer) videoPlayer.src = videoData.video_path;
                    if (downloadBtn) {
                        downloadBtn.href = videoData.video_path;
                        downloadBtn.download = videoData.video_path.split('/').pop();
                    }
                    if (videoResult) videoResult.style.display = 'block';

                    showToast(`ğŸ‰ ä¸€é”®ç”Ÿæˆå®Œæˆï¼æ—¶é•¿ ${videoData.duration.toFixed(1)}ç§’ï¼Œå¤§å° ${videoData.file_size_mb}MB`, 'success', 5000);
                } else {
                    showToast('è§†é¢‘åˆæˆå¤±è´¥: ' + videoData.message, 'error');
                }
            } catch (error) {
                showToast('ä¸€é”®ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function resetSelection() {
            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
            document.querySelectorAll('.selectable-image').forEach(img => {
                img.classList.remove('selected');
            });
            selectedImages = [];
            
            // é‡ç½®å†…å®¹
            if (currentData && currentData.content_file) {
                fetch(currentData.content_file)
                    .then(response => response.text())
                    .then(content => {
                        const lines = content.split('\n');
                        const contentStart = lines.findIndex(line => line.includes('===='));
                        const actualContent = lines.slice(contentStart + 2).join('\n').trim();
                        document.getElementById('contentEditor').value = actualContent;
                    });
            }
            
            // éšè—æ’åºé¢æ¿
            hideSortPanel();
            
            // éšè—AIæ‘˜è¦
            document.getElementById('aiSummary').style.display = 'none';
            
            alert('å·²é‡ç½®æ‰€æœ‰é€‰æ‹©');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.classList.add('active');
        }

        // æ”¯æŒå›è½¦é”®æäº¤
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchUrl();
            }
        });

        // ===== å›¾ç‰‡æŸ¥çœ‹å™¨ & å»æ°´å°åŠŸèƒ½ =====
        let modalState = {
            currentPath: '',       // å½“å‰å›¾ç‰‡è·¯å¾„
            cleanedPath: '',       // å»æ°´å°åè·¯å¾„
            zoom: 1,
            drawMode: false,
            drawing: false,
            isFullscreen: true,    // å…¨å±çŠ¶æ€
            regions: [],           // æ¡†é€‰çš„æ°´å°åŒºåŸŸ [{x, y, width, height}]
            startX: 0,
            startY: 0,
            imgNaturalW: 0,
            imgNaturalH: 0,
            imgDisplayW: 0,
            imgDisplayH: 0,
            imgOffsetX: 0,
            imgOffsetY: 0,
            sourceElement: null,   // ç‚¹å‡»æ¥æºçš„imgå…ƒç´ 
            skipAutoDetect: false  // å»æ°´å°åè·³è¿‡è‡ªåŠ¨æ£€æµ‹
        };

        function openImageModal(imgSrc, sourceEl) {
            modalState.currentPath = imgSrc;
            modalState.cleanedPath = '';
            modalState.zoom = 1;
            modalState.drawMode = false;
            modalState.regions = [];
            modalState.sourceElement = sourceEl || null;
            modalState.skipAutoDetect = false;

            const overlay = document.getElementById('imageModalOverlay');
            const img = document.getElementById('modalImage');
            
            img.src = imgSrc;
            img.style.transform = 'scale(1)';
            
            overlay.classList.add('active');
            document.getElementById('drawModeBtn').classList.remove('active');
            document.getElementById('drawModeBtn').textContent = 'âœï¸ æ¡†é€‰æ°´å°';
            document.getElementById('removeWatermarkBtn').disabled = true;
            document.getElementById('useCleanedBtn').style.display = 'none';
            document.getElementById('undoRegionBtn').style.display = 'none';
            document.getElementById('clearRegionsBtn').style.display = 'none';
            document.getElementById('regionsCount').innerHTML = '';
            document.getElementById('zoomLevel').textContent = '100%';
            document.getElementById('modalTitle').textContent = 'ğŸ” å›¾ç‰‡æŸ¥çœ‹å™¨';

            img.onload = function() {
                modalState.imgNaturalW = img.naturalWidth;
                modalState.imgNaturalH = img.naturalHeight;
                document.getElementById('modalImageInfo').textContent = 
                    `${img.naturalWidth} Ã— ${img.naturalHeight} px`;
                updateCanvasSize();
                
                // é»˜è®¤è¿›å…¥æ¡†é€‰æ¨¡å¼
                if (!modalState.drawMode) {
                    toggleDrawMode();
                }
                // ä¸å†è‡ªåŠ¨æ£€æµ‹æ°´å°ï¼Œç”¨æˆ·å¯æ‰‹åŠ¨ç‚¹å‡»"è‡ªåŠ¨æ£€æµ‹"æŒ‰é’®
                // if (!modalState.skipAutoDetect) {
                //     autoDetectWatermark();
                // }
            };
        }

        function closeImageModal() {
            document.getElementById('imageModalOverlay').classList.remove('active');
            clearCanvas();
            toggleRegionPanel(false);
            modalState.isFullscreen = true;  // é‡ç½®ä¸ºå…¨å±æ¨¡å¼
            updateFullscreenButton();
        }

        function toggleFullscreen() {
            modalState.isFullscreen = !modalState.isFullscreen;
            const modal = document.querySelector('.image-modal');
            const btn = document.getElementById('fullscreenBtn');
            
            if (modalState.isFullscreen) {
                // åˆ‡æ¢åˆ°å…¨å±
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.maxWidth = 'none';
                modal.style.maxHeight = 'none';
                modal.style.borderRadius = '0';
                btn.innerHTML = 'ğŸ”² å…¨å±';
                btn.title = 'é€€å‡ºå…¨å±';
            } else {
                // åˆ‡æ¢åˆ°çª—å£æ¨¡å¼
                modal.style.width = '95vw';
                modal.style.height = '90vh';
                modal.style.maxWidth = '1200px';
                modal.style.maxHeight = '800px';
                modal.style.borderRadius = '12px';
                btn.innerHTML = 'ğŸ”³ çª—å£';
                btn.title = 'å…¨å±æ˜¾ç¤º';
            }
            
            // é‡æ–°è®¡ç®—å›¾ç‰‡æ˜¾ç¤ºå°ºå¯¸
            setTimeout(updateCanvasSize, 100);
        }

        function updateFullscreenButton() {
            const btn = document.getElementById('fullscreenBtn');
            if (btn) {
                if (modalState.isFullscreen) {
                    btn.innerHTML = 'ğŸ”² å…¨å±';
                    btn.title = 'é€€å‡ºå…¨å±';
                } else {
                    btn.innerHTML = 'ğŸ”³ çª—å£';
                    btn.title = 'å…¨å±æ˜¾ç¤º';
                }
            }
        }

        function zoomImage(delta) {
            modalState.zoom = Math.max(0.2, Math.min(5, modalState.zoom + delta));
            document.getElementById('modalImage').style.transform = `scale(${modalState.zoom})`;
            document.getElementById('zoomLevel').textContent = `${Math.round(modalState.zoom * 100)}%`;
            updateCanvasSize();
        }

        function resetZoom() {
            modalState.zoom = 1;
            document.getElementById('modalImage').style.transform = 'scale(1)';
            document.getElementById('zoomLevel').textContent = '100%';
            updateCanvasSize();
        }

        function toggleDrawMode() {
            modalState.drawMode = !modalState.drawMode;
            const btn = document.getElementById('drawModeBtn');
            const canvas = document.getElementById('modalCanvas');
            
            if (modalState.drawMode) {
                btn.classList.add('active');
                btn.textContent = 'âœï¸ æ¡†é€‰ä¸­...';
                canvas.style.pointerEvents = 'auto';
                // é‡ç½®ç¼©æ”¾åˆ°100%æ–¹ä¾¿æ¡†é€‰
                resetZoom();
            } else {
                btn.classList.remove('active');
                btn.textContent = 'âœï¸ æ¡†é€‰æ°´å°';
                canvas.style.pointerEvents = 'none';
            }
        }

        function updateCanvasSize() {
            const body = document.getElementById('modalBody');
            const img = document.getElementById('modalImage');
            const canvas = document.getElementById('modalCanvas');
            
            // è·å–å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„å®é™…æ¸²æŸ“å°ºå¯¸å’Œä½ç½®
            const bodyRect = body.getBoundingClientRect();
            canvas.width = bodyRect.width;
            canvas.height = bodyRect.height;
            
            // è®¡ç®—å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„å®é™…æ˜¾ç¤ºå°ºå¯¸ï¼ˆè€ƒè™‘object-fit: containï¼‰
            const imgRect = img.getBoundingClientRect();
            const bodyR = body.getBoundingClientRect();
            
            modalState.imgDisplayW = imgRect.width;
            modalState.imgDisplayH = imgRect.height;
            modalState.imgOffsetX = imgRect.left - bodyR.left;
            modalState.imgOffsetY = imgRect.top - bodyR.top;
            
            // é‡ç»˜å·²æœ‰çš„æ¡†é€‰åŒºåŸŸ
            redrawRegions();
        }

        function getCanvasCoords(e) {
            const canvas = document.getElementById('modalCanvas');
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        // å°†canvasåæ ‡è½¬æ¢ä¸ºå›¾ç‰‡åŸå§‹åƒç´ åæ ‡
        function canvasToImageCoords(cx, cy) {
            const scaleX = modalState.imgNaturalW / modalState.imgDisplayW;
            const scaleY = modalState.imgNaturalH / modalState.imgDisplayH;
            
            const imgX = (cx - modalState.imgOffsetX) * scaleX;
            const imgY = (cy - modalState.imgOffsetY) * scaleY;
            
            return {
                x: Math.max(0, Math.min(modalState.imgNaturalW, imgX)),
                y: Math.max(0, Math.min(modalState.imgNaturalH, imgY))
            };
        }

        // å°†å›¾ç‰‡åŸå§‹åƒç´ åæ ‡è½¬æ¢ä¸ºcanvasåæ ‡
        function imageToCanvasCoords(ix, iy) {
            const scaleX = modalState.imgDisplayW / modalState.imgNaturalW;
            const scaleY = modalState.imgDisplayH / modalState.imgNaturalH;
            
            return {
                x: ix * scaleX + modalState.imgOffsetX,
                y: iy * scaleY + modalState.imgOffsetY
            };
        }

        function redrawRegions() {
            const canvas = document.getElementById('modalCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            modalState.regions.forEach((region, idx) => {
                const topLeft = imageToCanvasCoords(region.x, region.y);
                const bottomRight = imageToCanvasCoords(region.x + region.width, region.y + region.height);
                const w = bottomRight.x - topLeft.x;
                const h = bottomRight.y - topLeft.y;
                
                // åŠé€æ˜çº¢è‰²å¡«å……
                ctx.fillStyle = 'rgba(233, 69, 96, 0.25)';
                ctx.fillRect(topLeft.x, topLeft.y, w, h);
                
                // çº¢è‰²è™šçº¿è¾¹æ¡†
                ctx.strokeStyle = '#e94560';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 3]);
                ctx.strokeRect(topLeft.x, topLeft.y, w, h);
                ctx.setLineDash([]);
                
                // åŒºåŸŸç¼–å·
                ctx.fillStyle = '#e94560';
                ctx.font = 'bold 14px sans-serif';
                ctx.fillText(`${idx + 1}`, topLeft.x + 4, topLeft.y + 16);
            });
        }

        function clearCanvas() {
            const canvas = document.getElementById('modalCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function updateRegionUI() {
            const count = modalState.regions.length;
            // æ›´æ–°åº•éƒ¨å¾½ç« ï¼ˆç‚¹å‡»å¯åˆ‡æ¢é¢æ¿ï¼‰
            document.getElementById('regionsCount').innerHTML = count > 0 
                ? `<span class="region-badge" style="cursor:pointer;" onclick="toggleRegionPanel()" title="æŸ¥çœ‹åŒºåŸŸåˆ—è¡¨">${count} ä¸ªåŒºåŸŸ â–¸</span>` : '';
            document.getElementById('removeWatermarkBtn').disabled = count === 0;
            document.getElementById('undoRegionBtn').style.display = count > 0 ? 'inline-block' : 'none';
            document.getElementById('clearRegionsBtn').style.display = count > 0 ? 'inline-block' : 'none';
            
            // æ›´æ–°åŒºåŸŸåˆ—è¡¨é¢æ¿å†…å®¹
            const listBody = document.getElementById('regionListBody');
            const listFooter = document.getElementById('regionListFooter');
            const panel = document.getElementById('regionListPanel');
            
            if (count === 0) {
                listBody.innerHTML = '<div class="region-list-empty">æš‚æ— æ£€æµ‹åŒºåŸŸ<br><small style="color:#555;">ä½¿ç”¨"è‡ªåŠ¨æ£€æµ‹"æˆ–"æ¡†é€‰æ°´å°"æ·»åŠ </small></div>';
                listFooter.style.display = 'none';
                panel.classList.remove('active');
            } else {
                let html = '';
                modalState.regions.forEach((r, idx) => {
                    html += `<div class="region-list-item" data-region-idx="${idx}" 
                                  onmouseenter="highlightRegion(${idx}, true)" 
                                  onmouseleave="highlightRegion(${idx}, false)"
                                  onclick="focusRegion(${idx})">
                        <span class="region-item-num">${idx + 1}</span>
                        <div class="region-item-info">
                            <div class="region-item-size">${r.width} Ã— ${r.height} px</div>
                            <div class="region-item-pos">ä½ç½®: (${r.x}, ${r.y})</div>
                        </div>
                        <button class="region-item-del" onclick="event.stopPropagation(); removeRegion(${idx})" title="åˆ é™¤æ­¤åŒºåŸŸ">âœ•</button>
                    </div>`;
                });
                listBody.innerHTML = html;
                listFooter.style.display = 'block';
                // è‡ªåŠ¨æ˜¾ç¤ºé¢æ¿
                panel.classList.add('active');
            }
        }

        function toggleRegionPanel(forceState) {
            const panel = document.getElementById('regionListPanel');
            if (typeof forceState === 'boolean') {
                panel.classList.toggle('active', forceState);
            } else {
                panel.classList.toggle('active');
            }
        }

        function removeRegion(index) {
            if (index >= 0 && index < modalState.regions.length) {
                modalState.regions.splice(index, 1);
                redrawRegions();
                updateRegionUI();
                showToast(`å·²åˆ é™¤åŒºåŸŸ ${index + 1}`, 'info', 2000);
            }
        }

        function highlightRegion(index, isHighlight) {
            // é«˜äº®åˆ—è¡¨é¡¹
            const items = document.querySelectorAll('.region-list-item');
            items.forEach((item, i) => {
                item.classList.toggle('highlighted', i === index && isHighlight);
            });
            
            // åœ¨canvasä¸Šé«˜äº®æ˜¾ç¤ºå¯¹åº”åŒºåŸŸ
            redrawRegions();
            if (isHighlight && index >= 0 && index < modalState.regions.length) {
                const region = modalState.regions[index];
                const canvas = document.getElementById('modalCanvas');
                const ctx = canvas.getContext('2d');
                
                const topLeft = imageToCanvasCoords(region.x, region.y);
                const bottomRight = imageToCanvasCoords(region.x + region.width, region.y + region.height);
                const w = bottomRight.x - topLeft.x;
                const h = bottomRight.y - topLeft.y;
                
                // åŠ ç²—é«˜äº®è¾¹æ¡†
                ctx.strokeStyle = '#ffcc00';
                ctx.lineWidth = 3;
                ctx.setLineDash([]);
                ctx.strokeRect(topLeft.x - 1, topLeft.y - 1, w + 2, h + 2);
                
                // é»„è‰²åŠé€æ˜è¦†ç›–
                ctx.fillStyle = 'rgba(255, 204, 0, 0.15)';
                ctx.fillRect(topLeft.x, topLeft.y, w, h);
            }
        }

        function focusRegion(index) {
            // ç‚¹å‡»åˆ—è¡¨é¡¹æ—¶é—ªçƒå¯¹åº”åŒºåŸŸ
            highlightRegion(index, true);
            setTimeout(() => {
                highlightRegion(index, false);
                setTimeout(() => highlightRegion(index, true), 150);
                setTimeout(() => highlightRegion(index, false), 600);
            }, 300);
        }

        function undoLastRegion() {
            modalState.regions.pop();
            redrawRegions();
            updateRegionUI();
        }

        function clearRegions() {
            modalState.regions = [];
            clearCanvas();
            updateRegionUI();
            toggleRegionPanel(false);
        }

        // Canvasäº‹ä»¶ï¼šç”»æ¡†
        const modalCanvas = document.getElementById('modalCanvas');
        modalCanvas.style.pointerEvents = 'none';

        modalCanvas.addEventListener('mousedown', function(e) {
            if (!modalState.drawMode) return;
            const coords = getCanvasCoords(e);
            modalState.drawing = true;
            modalState.startX = coords.x;
            modalState.startY = coords.y;
        });

        modalCanvas.addEventListener('mousemove', function(e) {
            if (!modalState.drawing || !modalState.drawMode) return;
            const coords = getCanvasCoords(e);
            
            // é‡ç»˜å·²æœ‰åŒºåŸŸ + å½“å‰æ­£åœ¨ç”»çš„æ¡†
            redrawRegions();
            
            const ctx = modalCanvas.getContext('2d');
            const x = Math.min(modalState.startX, coords.x);
            const y = Math.min(modalState.startY, coords.y);
            const w = Math.abs(coords.x - modalState.startX);
            const h = Math.abs(coords.y - modalState.startY);
            
            ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.strokeRect(x, y, w, h);
            ctx.setLineDash([]);
        });

        modalCanvas.addEventListener('mouseup', function(e) {
            if (!modalState.drawing || !modalState.drawMode) return;
            modalState.drawing = false;
            
            const coords = getCanvasCoords(e);
            const cx = Math.min(modalState.startX, coords.x);
            const cy = Math.min(modalState.startY, coords.y);
            const cw = Math.abs(coords.x - modalState.startX);
            const ch = Math.abs(coords.y - modalState.startY);
            
            // å¿½ç•¥å¤ªå°çš„æ¡†é€‰ï¼ˆå°äº5pxçš„æ„å¤–ç‚¹å‡»ï¼‰
            if (cw < 5 || ch < 5) {
                redrawRegions();
                return;
            }
            
            // è½¬æ¢ä¸ºå›¾ç‰‡åŸå§‹åæ ‡
            const topLeft = canvasToImageCoords(cx, cy);
            const bottomRight = canvasToImageCoords(cx + cw, cy + ch);
            
            const region = {
                x: Math.round(topLeft.x),
                y: Math.round(topLeft.y),
                width: Math.round(bottomRight.x - topLeft.x),
                height: Math.round(bottomRight.y - topLeft.y)
            };
            
            if (region.width > 0 && region.height > 0) {
                modalState.regions.push(region);
            }
            
            redrawRegions();
            updateRegionUI();
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
        window.addEventListener('resize', function() {
            if (document.getElementById('imageModalOverlay').classList.contains('active')) {
                setTimeout(updateCanvasSize, 100);
            }
        });

        async function autoDetectWatermark() {
            const btn = document.getElementById('autoDetectBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ” æ£€æµ‹ä¸­...';
            
            try {
                const response = await fetch('/api/detect-watermark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_path: modalState.currentPath })
                });
                const data = await response.json();
                
                if (data.success && data.regions && data.regions.length > 0) {
                    // å°†æ£€æµ‹åˆ°çš„åŒºåŸŸæ·»åŠ åˆ°æ¡†é€‰åˆ—è¡¨
                    data.regions.forEach(r => modalState.regions.push(r));
                    redrawRegions();
                    updateRegionUI();
                    showToast(`æ£€æµ‹åˆ° ${data.regions.length} ä¸ªå¯ç–‘æ°´å°åŒºåŸŸ`, 'success');
                } else {
                    showToast('æœªæ£€æµ‹åˆ°æ˜æ˜¾æ°´å°ï¼Œè¯·æ‰‹åŠ¨æ¡†é€‰', 'info');
                }
            } catch (error) {
                showToast('è‡ªåŠ¨æ£€æµ‹å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ” è‡ªåŠ¨æ£€æµ‹';
            }
        }

        async function autoDetectAndRemove() {
            const btn = document.getElementById('autoRemoveBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸš€ æ£€æµ‹ä¸­...';
            
            try {
                // ç¬¬1æ­¥ï¼šè‡ªåŠ¨æ£€æµ‹
                const detectResp = await fetch('/api/detect-watermark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_path: modalState.currentPath })
                });
                const detectData = await detectResp.json();
                
                if (!detectData.success || !detectData.regions || detectData.regions.length === 0) {
                    showToast('æœªæ£€æµ‹åˆ°æ°´å°åŒºåŸŸï¼Œè¯·æ‰‹åŠ¨æ¡†é€‰åå»é™¤', 'info');
                    return;
                }
                
                // å°†æ£€æµ‹åŒºåŸŸæ˜¾ç¤ºå‡ºæ¥
                modalState.regions = detectData.regions;
                redrawRegions();
                updateRegionUI();
                showToast(`æ£€æµ‹åˆ° ${detectData.regions.length} ä¸ªæ°´å°åŒºåŸŸï¼Œæ­£åœ¨å»é™¤...`, 'info');
                
                // ç¬¬2æ­¥ï¼šè‡ªåŠ¨å»é™¤
                btn.textContent = 'ğŸš€ å»é™¤ä¸­...';
                
                const removeResp = await fetch('/api/remove-watermark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: modalState.currentPath,
                        regions: modalState.regions
                    })
                });
                const removeData = await removeResp.json();
                
                if (removeData.success) {
                    modalState.cleanedPath = removeData.cleaned_path;
                    modalState.skipAutoDetect = true;
                    document.getElementById('modalImage').src = removeData.cleaned_path + '?t=' + Date.now();
                    document.getElementById('modalTitle').textContent = 'âœ… å»æ°´å°å®Œæˆ - ç‚¹å‡»"ä½¿ç”¨æ­¤å›¾"æ›¿æ¢åŸå›¾';
                    document.getElementById('useCleanedBtn').style.display = 'inline-block';
                    
                    modalState.regions = [];
                    clearCanvas();
                    updateRegionUI();
                    
                    showToast(`å·²è‡ªåŠ¨æ£€æµ‹å¹¶å»é™¤ ${detectData.regions.length} ä¸ªæ°´å°åŒºåŸŸ`, 'success');
                } else {
                    showToast('å»æ°´å°å¤±è´¥: ' + removeData.message, 'error');
                }
            } catch (error) {
                showToast('ä¸€é”®å»æ°´å°å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ä¸€é”®å»æ°´å°';
            }
        }

        async function removeWatermark() {
            if (modalState.regions.length === 0) {
                alert('è¯·å…ˆæ¡†é€‰æ°´å°åŒºåŸŸ');
                return;
            }
            
            const btn = document.getElementById('removeWatermarkBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ§¹ å¤„ç†ä¸­...';
            
            try {
                const response = await fetch('/api/remove-watermark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: modalState.currentPath,
                        regions: modalState.regions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ˜¾ç¤ºå»æ°´å°åçš„å›¾ç‰‡
                    modalState.cleanedPath = data.cleaned_path;
                    modalState.skipAutoDetect = true;  // å»æ°´å°åçš„å›¾ä¸å†è‡ªåŠ¨æ£€æµ‹
                    document.getElementById('modalImage').src = data.cleaned_path + '?t=' + Date.now();
                    document.getElementById('modalTitle').textContent = 'âœ… å»æ°´å°å®Œæˆ - ç‚¹å‡»"ä½¿ç”¨æ­¤å›¾"æ›¿æ¢åŸå›¾';
                    document.getElementById('useCleanedBtn').style.display = 'inline-block';
                    
                    // æ¸…é™¤æ¡†é€‰
                    modalState.regions = [];
                    clearCanvas();
                    updateRegionUI();
                    
                    showToast('æ°´å°å»é™¤æˆåŠŸï¼å¯ç‚¹å‡»ã€Œä½¿ç”¨æ­¤å›¾ã€æ›¿æ¢', 'success');
                } else {
                    showToast('å»æ°´å°å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('å»æ°´å°å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = modalState.regions.length === 0;
                btn.textContent = 'ğŸ§¹ å»é™¤æ°´å°';
            }
        }

        function useCleanedImage() {
            if (!modalState.cleanedPath || !modalState.sourceElement) return;
            
            const newPath = modalState.cleanedPath;
            const oldPath = modalState.currentPath;
            
            // æ›´æ–°åŸå›¾é¢„è§ˆä¸ºå»æ°´å°åçš„å›¾ç‰‡
            modalState.sourceElement.src = newPath;
            
            // æ›´æ–°data-pathï¼ˆç”¨äºåç»­é€‰ä¸­ç”Ÿæˆå…³é”®å¸§ï¼‰
            const parent = modalState.sourceElement.closest('.selectable-image');
            if (parent) {
                parent.dataset.path = newPath;
                // å¦‚æœè¯¥å›¾ç‰‡å·²è¢«é€‰ä¸­ï¼Œä¹Ÿæ›´æ–°selectedImages
                const idx = selectedImages.indexOf(oldPath);
                if (idx >= 0) {
                    selectedImages[idx] = newPath;
                }
            }
            
            // åŒæ­¥æ›´æ–°image-cardä¸­çš„å›¾ç‰‡ï¼ˆé¡¶éƒ¨é¢„è§ˆåŒºåŸŸï¼‰
            document.querySelectorAll('.image-card img').forEach(img => {
                if (img.src.endsWith(oldPath) || img.getAttribute('src') === oldPath) {
                    img.src = newPath;
                }
            });
            
            closeImageModal();
            showToast('å·²æ›¿æ¢ä¸ºå»æ°´å°åçš„å›¾ç‰‡', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initializeEventListeners();
        });
        
        function initializeEventListeners() {
            // æ’åºé¢æ¿ç›¸å…³äº‹ä»¶
            const closeBtn = document.getElementById('closeSortPanel');
            const resetBtn = document.getElementById('resetOrder');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideSortPanel);
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', resetImageOrder);
            }
        }
        
        function getCombinedTitle() {
            // è·å–ç»„åˆåçš„æ ‡é¢˜ï¼ˆä¸»æ ‡é¢˜ + å‰¯æ ‡é¢˜ï¼‰
            const mainTitle = document.getElementById('editableMainTitle')?.value.trim() || '';
            const subTitle = document.getElementById('editableSubTitle')?.value.trim() || '';
            
            if (subTitle) {
                return `${mainTitle}|${subTitle}`;
            }
            return mainTitle;
        }
        
        // ==================== è§†é¢‘æŸ¥çœ‹åŠŸèƒ½ ====================
        
        function openVideoModal(videoPath) {
            console.log('æ‰“å¼€è§†é¢‘æ¨¡æ€æ¡†:', videoPath);
            
            const overlay = document.getElementById('videoModalOverlay');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoInfo = document.getElementById('videoInfo');
            
            if (!overlay || !videoPlayer || !videoInfo) {
                console.error('è§†é¢‘æ¨¡æ€æ¡†å…ƒç´ ç¼ºå¤±');
                return;
            }
            
            // è®¾ç½®è§†é¢‘æº
            videoPlayer.src = videoPath;
            videoPlayer.load();
            
            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            const filename = videoPath.split('/').pop();
            videoInfo.innerHTML = `
                <strong>æ–‡ä»¶:</strong> ${filename}<br>
                <strong>çŠ¶æ€:</strong> åŠ è½½ä¸­...
            `;
            
            // è§†é¢‘åŠ è½½äº‹ä»¶
            videoPlayer.onloadedmetadata = function() {
                const duration = videoPlayer.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                videoInfo.innerHTML = `
                    <strong>æ–‡ä»¶:</strong> ${filename}<br>
                    <strong>æ—¶é•¿:</strong> ${minutes}:${seconds.toString().padStart(2, '0')}<br>
                    <strong>åˆ†è¾¨ç‡:</strong> ${videoPlayer.videoWidth}Ã—${videoPlayer.videoHeight}
                `;
            };
            
            videoPlayer.onerror = function(e) {
                videoInfo.innerHTML = `
                    <strong>æ–‡ä»¶:</strong> ${filename}<br>
                    <strong style="color: #e74c3c;">é”™è¯¯:</strong> è§†é¢‘åŠ è½½å¤±è´¥
                `;
                console.error('è§†é¢‘åŠ è½½é”™è¯¯:', e);
            };
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeVideoModal() {
            const overlay = document.getElementById('videoModalOverlay');
            const videoPlayer = document.getElementById('videoPlayer');
            
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            if (videoPlayer) {
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
            }
        }
        
        function downloadCurrentVideo() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer && videoPlayer.src) {
                const link = document.createElement('a');
                link.href = videoPlayer.src;
                link.download = 'video_' + new Date().getTime() + '.mp4';
                link.click();
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(e) {
            if (e.target.id === 'videoModalOverlay') {
                closeVideoModal();
            }
        });
    </script>
</body>
</html>

<!-- è§†é¢‘æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div class="image-modal-overlay" id="videoModalOverlay" onclick="if(event.target===this)closeVideoModal()" style="display: none;">
    <div class="image-modal">
        <div class="image-modal-header">
            <h3 id="videoModalTitle">ğŸ¬ è§†é¢‘é¢„è§ˆ</h3>
            <div class="modal-toolbar">
                <button class="modal-btn-zoom" onclick="downloadCurrentVideo()" title="ä¸‹è½½è§†é¢‘">ğŸ“¥ ä¸‹è½½</button>
                <span style="color:#555;">|</span>
                <button class="modal-btn-close" onclick="closeVideoModal()">âœ•</button>
            </div>
        </div>
        <div class="image-modal-body" id="videoModalBody" style="background: #000;">
            <video id="videoPlayer" controls style="width: 100%; height: 100%; object-fit: contain;" preload="metadata">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
            </video>
        </div>
        <div class="image-modal-footer">
            <div class="image-info" id="videoInfo">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
</div>
