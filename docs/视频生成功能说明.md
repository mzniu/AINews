# 视频生成功能说明

## 功能概述
将多个关键帧合成为视频，每帧显示2.5秒，支持添加背景音乐。

## 使用流程

### 1. 抓取内容
在前端页面输入AI资讯网站URL，系统会自动抓取：
- 文章标题
- 文章内容
- 相关图片

### 2. 生成关键帧
1. 选择多张图片（点击图片添加蓝色边框）
2. 编辑文章内容
3. 点击"📝 生成AI摘要"按钮，使用DeepSeek API生成：
   - 标题（25字以内）
   - 摘要（100字以内）
4. 点击"🎨 生成视频关键帧"按钮

系统会为每张选中的图片生成一个关键帧，包含：
- 背景渐变图（1080x1920）
- 用户选择的新闻图片（100%宽度，最大60%高度，垂直居中）
- 标题（固定在上方15%位置，带半透明灰色背景）
- 摘要（固定在下方85%位置，带半透明灰色背景）

### 3. 合成视频
1. 关键帧生成完成后，会显示"🎬 合成视频 (2.5秒/帧)"按钮
2. 点击按钮开始视频合成
3. 合成参数：
   - 每帧时长：2.5秒
   - 视频帧率：24fps
   - 视频编码：H.264 (libx264)
   - 音频编码：AAC（如果有背景音乐）
4. 视频生成完成后，可在线预览和下载

## 技术实现

### 后端 API
- **接口**: `POST /api/create-video`
- **请求参数**:
  ```json
  {
    "frames_dir": "data/generated/frames_20260205_161451",
    "duration_per_frame": 2.5,
    "audio_path": "static/music/background.mp3"
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "message": "视频生成成功",
    "video_path": "/data/videos/video_20260205_162530.mp4",
    "frames_count": 2,
    "duration": 5.0,
    "file_size_mb": 1.23
  }
  ```

### 使用的库
- **moviepy**: 视频合成、音频处理
- **FFmpeg**: 底层视频编码（moviepy依赖）

### 视频生成流程
1. 读取关键帧目录下的所有 `frame_*.png` 图片
2. 为每张图片创建 `ImageClip`，设置时长为 2.5 秒
3. 使用 `concatenate_videoclips` 拼接所有片段
4. 如果提供了背景音乐：
   - 加载音频文件
   - 循环音频以匹配视频长度
   - 将音频设置到视频上
5. 使用 H.264 编码导出 MP4 视频

## 添加背景音乐（可选）

### 准备音乐文件
1. 将 MP3 格式的背景音乐放到 `static/music/` 目录
2. 推荐音乐时长：30秒以上（会自动循环）
3. 推荐格式：MP3, 128kbps, 44.1kHz

### 使用音乐
前端代码中，修改 `createVideo()` 函数：
```javascript
body: JSON.stringify({
    frames_dir: window.generatedFramesDir,
    duration_per_frame: 2.5,
    audio_path: 'static/music/background.mp3'  // 指定音乐文件
})
```

## 输出文件

### 目录结构
```
data/
├── generated/
│   └── frames_20260205_161451/     # 关键帧目录
│       ├── frame_01.png
│       ├── frame_02.png
│       └── ...
└── videos/
    └── video_20260205_162530.mp4   # 生成的视频
```

### 视频规格
- 分辨率：1080x1920（竖屏，适合抖音/快手）
- 编码格式：H.264
- 文件格式：MP4
- 帧率：24fps
- 文件大小：约 0.5-1 MB/帧

## 性能说明

### 处理时间
- 2个关键帧：约 5-10 秒
- 5个关键帧：约 15-20 秒
- 10个关键帧：约 30-40 秒

### 系统要求
- CPU：多核处理器（视频编码使用多线程）
- 内存：至少 2GB 可用内存
- 磁盘：每个视频约 5-20MB
- FFmpeg：moviepy 依赖（自动安装）

## 常见问题

### Q: 视频生成失败
**A**: 检查以下项：
1. FFmpeg 是否正确安装（moviepy会自动下载）
2. 关键帧目录是否存在
3. 磁盘空间是否充足
4. 查看后端日志 `logs/web_server_*.log`

### Q: 视频无声音
**A**: 
1. 确认 `audio_path` 参数是否正确
2. 音频文件是否存在
3. 音频格式是否为 MP3

### Q: 视频卡顿
**A**: 
1. 关键帧图片尺寸过大，建议控制在 2MB 以内
2. 帧率设置过高，建议使用 24fps
3. 系统性能不足，减少同时处理的视频数量

### Q: 如何调整视频参数
**A**: 修改 `web_server.py` 中的 `write_videofile` 参数：
```python
final_clip.write_videofile(
    str(output_path),
    fps=24,              # 帧率
    codec='libx264',     # 编码器
    bitrate="5000k",     # 码率（可选）
    preset='medium'      # 编码速度（可选：ultrafast, fast, medium, slow）
)
```

## 下一步优化

### 计划功能
- [ ] 支持更多视频格式（MOV, AVI）
- [ ] 关键帧间添加转场效果
- [ ] 支持文字动画
- [ ] 支持语音旁白（TTS）
- [ ] 批量生成多个视频
- [ ] 视频预设模板
- [ ] 实时预览

### 性能优化
- [ ] 使用 GPU 加速编码
- [ ] 多进程并行处理
- [ ] 缓存机制
- [ ] 进度条显示
