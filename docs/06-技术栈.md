# 技术栈选型

## 开发语言

### Python 3.11+
作为项目主要开发语言，Python在数据处理、爬虫、AI集成方面有丰富的生态。

**选择理由**:
- 爬虫框架成熟（Scrapy, BeautifulSoup）
- AI/ML库丰富（OpenAI SDK, Transformers）
- 视频处理能力强（MoviePy, FFmpeg）
- 开发效率高

## 核心依赖

### 1. Web爬虫
```
requests==2.31.0          # HTTP请求
beautifulsoup4==4.12.0    # HTML解析
scrapy==2.11.0            # 爬虫框架
selenium==4.16.0          # 浏览器自动化
lxml==5.1.0               # XML/HTML解析器
playwright==1.40.0        # 现代浏览器自动化（备选）
```

### 2. 数据存储
```
sqlalchemy==2.0.23        # ORM框架
psycopg2-binary==2.9.9    # PostgreSQL驱动
redis==5.0.1              # 缓存和去重
alembic==1.13.1           # 数据库迁移
```

### 3. AI集成
```
openai==1.6.1             # OpenAI SDK（DeepSeek兼容）
tiktoken==0.5.2           # Token计数
langchain==0.1.0          # LLM应用框架（可选）
```

### 4. 视频处理
```
moviepy==1.0.3            # 视频编辑
pillow==10.2.0            # 图像处理
opencv-python==4.9.0      # 计算机视觉
imageio==2.33.1           # 图像IO
imageio-ffmpeg==0.4.9     # FFmpeg封装
```

### 5. 文字转语音
```
edge-tts==6.1.9           # Edge TTS（推荐）
azure-cognitiveservices-speech==1.34.0  # Azure TTS（备选）
pydub==0.25.1             # 音频处理
```

### 6. 工具库
```
python-dotenv==1.0.0      # 环境变量管理
pydantic==2.5.3           # 数据验证
loguru==0.7.2             # 日志框架
schedule==1.2.0           # 任务调度
click==8.1.7              # CLI工具
rich==13.7.0              # 终端美化
```

### 7. 测试和质量
```
pytest==7.4.3             # 测试框架
pytest-asyncio==0.23.2    # 异步测试
pytest-cov==4.1.0         # 覆盖率
black==23.12.1            # 代码格式化
flake8==7.0.0             # 代码检查
mypy==1.8.0               # 类型检查
```

## 项目结构

```
AINews/
├── src/
│   ├── crawlers/              # 爬虫模块
│   │   ├── base.py           # 基础爬虫类
│   │   ├── jiqizhixin.py     # 机器之心
│   │   ├── qbitai.py         # 量子位
│   │   └── ...
│   ├── processors/            # 内容处理
│   │   ├── deepseek.py       # DeepSeek集成
│   │   ├── summarizer.py     # 总结器
│   │   └── script_gen.py     # 脚本生成
│   ├── generators/            # 视频生成
│   │   ├── tts.py            # 文字转语音
│   │   ├── subtitle.py       # 字幕生成
│   │   ├── composer.py       # 视频合成
│   │   └── templates/        # 视频模板
│   ├── models/                # 数据模型
│   │   ├── article.py
│   │   ├── summary.py
│   │   └── video.py
│   ├── database/              # 数据库
│   │   ├── connection.py
│   │   └── migrations/
│   ├── utils/                 # 工具函数
│   │   ├── logger.py
│   │   ├── config.py
│   │   └── helpers.py
│   └── main.py               # 主入口
├── tests/                     # 测试代码
│   ├── test_crawlers/
│   ├── test_processors/
│   └── test_generators/
├── docs/                      # 文档
├── config/                    # 配置文件
│   ├── config.yaml
│   └── sources.yaml          # 爬虫源配置
├── data/                      # 数据目录
│   ├── raw/                  # 原始数据
│   ├── processed/            # 处理后数据
│   └── videos/               # 生成的视频
├── scripts/                   # 脚本工具
│   ├── run_crawler.py
│   ├── run_generator.py
│   └── deploy.sh
├── .env                       # 环境变量
├── .env.example              # 环境变量示例
├── requirements.txt          # 依赖列表
├── pyproject.toml            # 项目配置
├── Dockerfile                # Docker配置
├── docker-compose.yml        # Docker编排
└── README.md                 # 项目说明
```

## 环境配置

### .env 文件示例
```bash
# DeepSeek API
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 数据库
DATABASE_URL=postgresql://user:pass@localhost:5432/ainews
REDIS_URL=redis://localhost:6379/0

# Azure TTS（可选）
AZURE_SPEECH_KEY=xxxxx
AZURE_SPEECH_REGION=eastasia

# 视频配置
VIDEO_RESOLUTION=1080x1920
VIDEO_FORMAT=mp4
OUTPUT_DIR=/path/to/videos

# 爬虫配置
CRAWLER_DELAY=2
CRAWLER_TIMEOUT=30
USER_AGENT=Mozilla/5.0 ...

# 日志
LOG_LEVEL=INFO
LOG_FILE=/var/log/ainews.log
```

## 开发工具

### IDE推荐
- **VS Code** + Python插件
- **PyCharm Professional**

### 必备插件（VS Code）
- Python
- Pylance
- Black Formatter
- Ruff (Linter)
- Docker
- GitLens

### 版本控制
```bash
# Git配置
.gitignore          # 忽略文件
.gitattributes      # Git属性
```

## 部署方案

### 开发环境
```bash
# 虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt
```

### Docker部署
```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["python", "src/main.py"]
```

### 生产环境
- **应用服务器**: Gunicorn + Supervisor
- **定时任务**: Cron / APScheduler
- **进程管理**: Supervisor / systemd
- **反向代理**: Nginx（如需Web界面）

## CI/CD

### GitHub Actions
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
      - run: pip install -r requirements.txt
      - run: pytest
```

## 监控和日志

### 日志方案
- **Loguru**: 应用日志
- **文件轮转**: 每日切割，保留30天
- **日志级别**: DEBUG (开发) / INFO (生产)

### 监控指标
- 爬虫成功率
- API调用次数和成本
- 视频生成时长
- 系统资源使用

## 性能优化

### 爬虫性能
- 异步请求（aiohttp）
- 并发控制（信号量）
- 连接池复用

### 视频生成性能
- 多进程并行
- GPU加速（如可用）
- 低分辨率预览

### 数据库性能
- 索引优化
- 连接池
- 查询缓存（Redis）
